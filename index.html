<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ±æ­¢æ·±åº¦å°è¦½</title>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        /* --- åŸºç¤è¨­å®š --- */
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; padding: 0; background-color: #f4f7f6; color: #333; padding-bottom: 100px; }
        
        /* --- é ‚éƒ¨é€²åº¦æ¢ --- */
        .progress-container { position: fixed; top: 0; left: 0; width: 100%; height: 6px; background: #e0e0e0; z-index: 2000; }
        .progress-bar { height: 100%; background: linear-gradient(90deg, #ff8a00, #e52e71); width: 0%; transition: width 0.5s ease; border-radius: 0 3px 3px 0; }

        /* --- è™›æ“¬ Beacon é€šçŸ¥ --- */
        .beacon-banner {
            position: fixed; top: -120px; left: 5%; width: 90%;
            background: rgba(34, 34, 34, 0.95); color: white;
            padding: 12px 15px; border-radius: 50px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.3); z-index: 5000;
            display: flex; align-items: center; gap: 12px;
            transition: top 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            cursor: pointer; box-sizing: border-box;
        }
        .beacon-banner.show { top: 20px; } 
        .beacon-icon { width: 36px; height: 36px; background: #06C755; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 20px; flex-shrink: 0; }
        .beacon-text { flex: 1; font-size: 13px; line-height: 1.3; }
        .beacon-title { font-weight: bold; color: #fff; font-size: 14px; }
        .beacon-sub { color: #ccc; font-size: 11px; }

        /* --- Hero åœ–ç‰‡å€ --- */
        .hero-container { position: relative; width: 100%; height: 35vh; overflow: hidden; }
        .hero-img { width: 100%; height: 100%; object-fit: cover; }
        
        /* --- ä¸»è¦å…§å®¹å¡ç‰‡ --- */
        .content-card { position: relative; background: white; border-radius: 24px 24px 0 0; margin-top: -25px; padding: 25px; box-shadow: 0 -5px 20px rgba(0,0,0,0.05); min-height: 60vh; }
        
        /* --- æ¨™é¡Œå€ (å«æ„›å¿ƒæ”¶è—) --- */
        .title-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
        h1 { margin: 0; font-size: 24px; font-weight: 800; color: #2c3e50; }
        
        /* æ„›å¿ƒæŒ‰éˆ•æ¨£å¼ */
        .wish-btn { font-size: 28px; color: #ccc; cursor: pointer; transition: transform 0.2s; }
        .wish-btn.active { color: #ff4757; transform: scale(1.2); }

        .sub-tag { display: inline-block; font-size: 12px; color: #888; background: #eee; padding: 3px 8px; border-radius: 4px; margin-bottom: 15px; }

        /* --- ç°¡ä»‹å€ --- */
        .desc-box { margin-bottom: 25px; border-bottom: 1px solid #eee; padding-bottom: 15px; }
        .desc-text { font-size: 15px; line-height: 1.6; color: #555; max-height: 8.0em; overflow: hidden; transition: max-height 0.4s ease; margin-bottom: 12px; }
        .desc-text.expanded { max-height: none; overflow: visible; } 
        
        /* ç°¡ä»‹å‹•ä½œåˆ— (äº†è§£æ›´å¤š + å•ç­”) */
        .desc-actions { display: flex; justify-content: space-between; align-items: center; }
        .read-more-btn { color: #007bff; font-weight: bold; font-size: 14px; cursor: pointer; text-decoration: underline; }
        
        /* å•ç­”æŒ‰éˆ• */
        .quiz-trigger-btn { 
            background: #ff9f43; color: white; padding: 6px 12px; 
            border-radius: 20px; font-size: 13px; font-weight: bold; 
            cursor: pointer; display: flex; align-items: center; gap: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        /* --- äº¤é€šå·¥å…·ç®± --- */
        .transport-grid { display: flex; gap: 10px; margin-bottom: 20px; }
        .t-btn { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 4px; padding: 10px; border-radius: 12px; text-decoration: none; color: white; font-weight: bold; font-size: 13px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); transition: transform 0.1s; position: relative; overflow: hidden; text-align: center; }
        .t-btn:active { transform: scale(0.96); }
        .t-btn i { font-style: normal; font-size: 18px; display: block; margin-bottom: 2px;}
        .bg-ubike { background: linear-gradient(135deg, #fce38a 0%, #f38181 100%); color: #555; }
        .bg-bus   { background: #3498db; }
        .bg-uber  { background: #2c3e50; } 
        .bus-label { font-size: 11px; opacity: 0.9; line-height: 1.2; }

        /* --- äº’å‹•ä»»å‹™å€ (ç‹€æ…‹é¡¯ç¤º) --- */
        .game-section { background: #fff8e1; border: 2px dashed #ffc107; border-radius: 16px; padding: 20px; text-align: center; margin-bottom: 15px; }
        .game-title { font-weight: bold; color: #d35400; margin-bottom: 15px; font-size: 16px; }
        .task-grid { display: flex; justify-content: center; gap: 10px; margin-bottom: 10px; }
        /* ç§»é™¤ cursor: pointerï¼Œå› ç‚ºé€™è£¡ç¾åœ¨åªæ˜¯å±•ç¤º */
        .stamp-box { display: flex; flex-direction: column; align-items: center; gap: 5px; width: 55px; }
        
        .stamp { width: 40px; height: 40px; border-radius: 50%; background: #e0e0e0; color: #777; display: flex; align-items: center; justify-content: center; font-size: 18px; font-weight: bold; border: 2px solid #ddd; transition: all 0.3s; }
        
        /* å®Œæˆæ¨£å¼ (æ‰“å‹¾) */
        .stamp.active { 
            background: #ff512f; color: white; border-color: #ff512f; 
            transform: scale(1.1); box-shadow: 0 3px 8px rgba(255, 81, 47, 0.3);
        }
        .stamp-label { font-size: 10px; color: #888; margin-top: 4px; font-weight: bold;}
        .stamp.active + .stamp-label { color: #d35400; }

        /* --- åˆ†äº«èˆ‡æ–‡å­—é€£çµ --- */
        .share-text-link { text-align: center; margin: 15px 0; font-size: 15px; font-weight: bold; color: #555; cursor: pointer; text-decoration: underline; display: block; }

        /* --- åˆ†äº«é¸å–® --- */
        .share-modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 4000; display: none; align-items: flex-end; justify-content: center; animation: fadeIn 0.3s; }
        .share-sheet { background: white; width: 100%; max-width: 500px; border-radius: 20px 20px 0 0; padding: 25px; box-sizing: border-box; animation: slideUp 0.3s; }
        .share-title { font-size: 16px; font-weight: bold; color: #333; margin-bottom: 20px; text-align: center; }
        .share-grid { display: flex; justify-content: space-around; gap: 10px; }
        .share-item { display: flex; flex-direction: column; align-items: center; gap: 8px; cursor: pointer; color: #555; font-size: 12px; width: 70px; }
        .share-icon-box { width: 50px; height: 50px; border-radius: 12px; display: flex; align-items: center; justify-content: center; transition: transform 0.2s; background: white; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .share-item:active .share-icon-box { transform: scale(0.9); }
        .share-icon-box svg { width: 32px; height: 32px; }
        .close-share { margin-top: 20px; padding: 12px; width: 100%; border: none; background: #f1f3f5; color: #555; border-radius: 12px; font-weight: bold; cursor: pointer; }

        /* --- å•å·å€å¡Š --- */
        #survey-box { display: none; margin-top: 25px; animation: popUp 0.5s ease; padding-top: 20px; border-top: 1px solid #eee; }
        .survey-btn { display: block; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; text-align: center; padding: 16px; border-radius: 12px; text-decoration: none; font-weight: bold; box-shadow: 0 4px 15px rgba(118, 75, 162, 0.4); }

        /* --- ç´€å¿µç…§ --- */
        #memorial-box { display: none; margin-top: 25px; text-align: center; background: #fafafa; padding: 20px; border-radius: 12px; }
        .memorial-title { font-size: 16px; font-weight: 800; color: #2c3e50; margin-bottom: 5px; }
        .memorial-desc { font-size: 13px; color: #666; margin-bottom: 15px; }
        .upload-btn-wrapper { position: relative; overflow: hidden; display: inline-block; margin-bottom: 15px; }
        .btn-upload { border: 2px dashed #007bff; color: #007bff; background-color: white; padding: 8px 16px; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 14px; }
        .upload-btn-wrapper input[type=file] { font-size: 100px; position: absolute; left: 0; top: 0; opacity: 0; cursor: pointer; }
        #result-canvas { display: none; }
        #final-img { width: 100%; max-width: 250px; border: 1px solid #ddd; box-shadow: 0 4px 10px rgba(0,0,0,0.1); display: none; margin: 10px auto; border-radius: 8px; }
        .download-hint { display: none; color: #28a745; font-weight: bold; font-size: 14px; margin-top: 10px; background: #e8f5e9; padding: 10px; border-radius: 8px;}
        
        /* --- åº•éƒ¨å°èˆª --- */
        .sticky-footer { position: fixed; bottom: 0; left: 0; width: 100%; background: white; padding: 10px 15px; box-sizing: border-box; display: flex; gap: 10px; box-shadow: 0 -4px 20px rgba(0,0,0,0.08); z-index: 1000; padding-bottom: max(10px, env(safe-area-inset-bottom)); }
        .footer-btn { flex: 1; padding: 12px; border-radius: 10px; text-align: center; text-decoration: none; font-weight: bold; font-size: 15px; display: flex; align-items: center; justify-content: center; gap: 6px; }
        .btn-map { background: #f1f3f5; color: #495057; }
        .btn-food { background: #ff6b6b; color: white; }

        .reset-link { margin-top: 30px; text-align: center; font-size: 12px; color: #ccc; text-decoration: underline; cursor: pointer; }
        #loading { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; display: flex; align-items: center; justify-content: center; z-index: 3000; flex-direction: column; color: #888; }
        
        @keyframes popUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
    </style>
</head>
<body>

    <div id="loading"><div>â³ è¼‰å…¥ä¸­...</div></div>
    <div class="progress-container"><div id="progress-bar" class="progress-bar"></div></div>

    <div id="beacon-banner" class="beacon-banner" onclick="handleBeaconClick()">
        <div class="beacon-icon">ğŸ“¡</div>
        <div class="beacon-text">
            <div class="beacon-title">åµæ¸¬åˆ° LINE Beacon è¨Šè™Ÿ</div>
            <div class="beacon-sub">é™„è¿‘æœ‰éš±è—æ™¯é»ï¼é»æ“Šæ‰“å¡</div>
        </div>
    </div>

    <div id="main-content" style="display: none;">
        <div class="hero-container"><img id="spot-img" class="hero-img" src="" alt="æ™¯é»åœ–ç‰‡"></div>
        <div class="content-card">
            <span class="sub-tag">æ±æ­¢æ·±åº¦å°è¦½ NO.<span id="spot-index">1</span></span>
            
            <div class="title-row">
                <h1 id="spot-title"></h1>
                <div id="wish-btn" class="wish-btn" onclick="triggerWishlist()">â™¡</div>
            </div>
            
            <div class="desc-box">
                <div id="spot-desc-container" class="desc-text"><span id="spot-desc"></span></div>
                
                <div class="desc-actions">
                    <div id="read-more-btn" class="read-more-btn" onclick="toggleDesc()">â–¼ äº†è§£æ›´å¤šæ•…äº‹</div>
                    <div class="quiz-trigger-btn" onclick="triggerQuiz()">
                        <span>ğŸ§  çŸ¥è­˜å°å­¸å ‚</span>
                    </div>
                </div>
            </div>

            <div class="transport-grid">
                <a href="https://www.google.com/maps/search/YouBike/" target="_blank" class="t-btn bg-ubike" onclick="trackAction('click_ubike')">
                    <i>ğŸš²</i> YouBike
                </a>
                <a id="bus-btn" href="#" target="_blank" class="t-btn bg-bus" onclick="collectAction('bus')">
                    <i>ğŸšŒ</i> <span class="bus-label">å»ä¸‹ä¸€ç«™</span>
                </a>
                <a href="https://m.uber.com/ul" target="_blank" class="t-btn bg-uber" onclick="trackAction('click_uber')">
                    <i>ğŸš•</i> å« Uber
                </a>
            </div>

            <div style="text-align: center; margin-bottom: 20px;">
                <a href="https://www.xizhi.ntpc.gov.tw/home.jsp?id=1ee324bfb5e44418" target="_blank" style="font-size: 12px; color: #999; text-decoration: underline;">
                    ğŸ“„ Fç³»åˆ—ç¤¾å€å·´å£«æ™‚åˆ»è¡¨
                </a>
            </div>

            <div class="game-section">
                <div class="game-title">ğŸ† æ±æ­¢é”äººæŒ‘æˆ° (é€²åº¦: <span id="progress-text">0/5</span>)</div>
                <div class="task-grid">
                    
                    <div class="stamp-box">
                        <div class="stamp" id="stamp-map">ğŸ—ºï¸</div>
                        <div class="stamp-label">æ‰¾è·¯</div>
                    </div>

                    <div class="stamp-box">
                        <div class="stamp" id="stamp-quiz">â“</div>
                        <div class="stamp-label">å•ç­”</div>
                    </div>

                    <div class="stamp-box">
                        <div class="stamp" id="stamp-wish">â¤ï¸</div>
                        <div class="stamp-label">æƒ³å»</div>
                    </div>

                    <div class="stamp-box">
                        <div class="stamp" id="stamp-beacon">ğŸ“¡</div>
                        <div class="stamp-label">å°‹å¯¶</div>
                    </div>

                    <div class="stamp-box">
                        <div class="stamp" id="stamp-bus">ğŸšŒ</div>
                        <div class="stamp-label">äº¤é€š</div>
                    </div>

                </div>
                <div style="font-size: 12px; color:#888; margin-top:5px;">ğŸ’¡ è«‹å¾é é¢å„è™•å°‹æ‰¾äº’å‹•æ©Ÿæœƒï¼Œå®Œæˆä¸Šæ–¹æŒ‘æˆ°ï¼</div>
            </div>

            <div class="share-text-link" onclick="openShareModal()">ğŸ“¤ è¦ºå¾—ä¸éŒ¯ï¼Ÿæ‰“å¡ä¸¦åˆ†äº«çµ¦å¥½å‹</div>

            <div id="survey-box">
                <a href="#" target="_blank" class="survey-btn" onclick="trackAction('click_survey')">ğŸ“ ä»»å‹™é”æˆï¼å¡«å¯«å•å·é ˜å–è­‰æ›¸</a>
            </div>

            <div id="memorial-box">
                <div class="memorial-title">ğŸ é¡å¤–çå‹µï¼šå®Œè³½ç´€å¿µç…§</div>
                <p class="memorial-desc">æ‚¨å¯ä»¥è‡ªæ‹ä¸¦åˆæˆã€Œæ±æ­¢é”äººã€ç›¸æ¡†ç•™å¿µ</p>
                <div class="upload-btn-wrapper">
                    <button class="btn-upload">ğŸ“¸ é¸æ“‡ç…§ç‰‡ / é–‹å•Ÿç›¸æ©Ÿ</button>
                    <input type="file" id="upload-input" accept="image/*" onchange="handleImageUpload(event)">
                </div>
                
                <canvas id="result-canvas"></canvas>
                <img id="final-img" src="" alt="åˆæˆç…§ç‰‡">
                <div id="download-msg" class="download-hint">ğŸ‘† è«‹ã€Œé•·æŒ‰ä¸Šæ–¹åœ–ç‰‡ã€å„²å­˜è‡³æ‰‹æ©Ÿç›¸ç°¿</div>
            </div>

            <div class="reset-link" onclick="resetProgress()">â†º é‡ç½®æ¸¬è©¦é€²åº¦</div>
        </div>
    </div>

    <div class="sticky-footer">
        <a id="map-btn" href="#" class="footer-btn btn-map" target="_blank" onclick="handleClickWithTrack('map')">ğŸ“ å¸¶æˆ‘å»</a>
        <a id="food-btn" href="#" class="footer-btn btn-food" target="_blank" onclick="trackAction('click_food')">ğŸ´ é™„è¿‘ç¾é£Ÿ</a>
    </div>

    <div id="share-modal" class="share-modal-overlay" onclick="closeShareModal(event)">
        <div class="share-sheet">
            <div class="share-title">åˆ†äº«é€™å€‹æ™¯é» ğŸ“¢</div>
            <div class="share-grid">
                <div class="share-item" onclick="shareTo('line')">
                    <div class="share-icon-box" style="background:#06C755;">
                        <svg viewBox="0 0 24 24" fill="white"><path d="M22 10.3c0-4.7-4.3-8.6-10-8.6-5.4 0-10 3.9-10 8.6 0 4.2 3.8 7.8 8.4 8.5.3 0 .7.2.8.5 0 0 .3 1.1.3 1.3-.1.5-.4 1.8-1.7 2.5 1.4 0 4.3-.9 6-3.1 3.5-1.5 6.2-4.8 6.2-9.7zm-14.7.2c0-.3.3-.5.5-.5h4.8c.3 0 .5.2.5.5s-.2.5-.5.5h-4.2v1.3h4.2c.3 0 .5.2.5.5s-.2.5-.5.5h-4.8c-.3 0-.5-.2-.5-.5v-2.1zm8.7 2.1c0 .3-.2.5-.5.5h-1.3v-2.6h.5c.3 0 .5.2.5.5v2.1c.8 0 .8-.5.8-2.6h.6v2.6c0 .3-.2.5-.6.5h-.1zm-2.8-2.6h.5c.3 0 .5.2.5.5v1.3l1.8-1.8h.7l-1.9 1.9 2 2.1h-.7l-1.6-1.7v1.7c0 .3-.2.5-.5.5h-.5v-4.5zm-5.7 4.5h-.5v-4.5h.5v2.3l1.9-2.3h.7l-2.2 2.6 2.3 2.5h-.8l-1.9-2.1v2.1z"/></svg>
                    </div>
                    <span>LINE</span>
                </div>
                <div class="share-item" onclick="shareTo('fb')">
                    <div class="share-icon-box" style="background:#1877F2;">
                        <svg viewBox="0 0 24 24" fill="white"><path d="M22 12c0-5.5-4.5-10-10-10S2 6.5 2 12c0 5 3.7 9.1 8.4 9.9v-7H7.9V12h2.5V9.8c0-2.5 1.5-3.9 3.8-3.9 1.1 0 2.2.2 2.2.2v2.5h-1.3c-1.2 0-1.6.8-1.6 1.6V12h2.8l-.4 2.9h-2.4v7C18.3 21.1 22 17 22 12z"/></svg>
                    </div>
                    <span>Facebook</span>
                </div>
                <div class="share-item" onclick="shareTo('ig')">
                    <div class="share-icon-box" style="background: radial-gradient(circle at 30% 107%, #fdf497 0%, #fdf497 5%, #fd5949 45%, #d6249f 60%, #285AEB 90%);">
                        <svg viewBox="0 0 24 24" fill="white"><path d="M12 2.2c3.2 0 3.6 0 4.9.1 3.3.1 4.8 1.7 4.9 4.9.1 1.3.1 1.6.1 4.8 0 3.2 0 3.6-.1 4.9-.1 3.3-1.7 4.8-4.9 4.9-1.3.1-1.6.1-4.8.1-3.2 0-3.6 0-4.9-.1-3.3-.1-4.8-1.7-4.9-4.9-.1-1.3-.1-1.6-.1-4.8 0-3.2 0-3.6.1-4.9.1-3.3 1.7-4.8 4.9-4.9 1.3-.1 1.6-.1 4.8-.1zm0-2.2C8.7 0 8.3 0 7.1.1 2.8.3.3 2.8.1 7.1 0 8.3 0 8.7 0 12s0 3.7.1 4.9c.2 4.4 2.7 6.8 7 7 1.3.1 1.7.1 4.9.1s3.7 0 4.9-.1c4.4-.2 6.8-2.7 7-7 .1-1.3.1-1.7.1-4.9s0-3.7-.1-4.9c-.2-4.4-2.7-6.8-7-7C15.7 0 15.3 0 12 0zm0 5.8c-3.4 0-6.2 2.8-6.2 6.2s2.8 6.2 6.2 6.2 6.2-2.8 6.2-6.2-2.8-6.2-6.2-6.2zm0 10.2c-2.2 0-4-1.8-4-4s1.8-4 4-4 4 1.8 4 4-1.8 4-4 4zm6.4-10.4c0 .8-.6 1.4-1.4 1.4-.8 0-1.4-.6-1.4-1.4 0-.8.6-1.4 1.4-1.4.8 0 1.4.6 1.4 1.4z"/></svg>
                    </div>
                    <span>Instagram</span>
                </div>
                <div class="share-item" onclick="shareTo('copy')">
                    <div class="share-icon-box" style="background:#555;">
                        <svg viewBox="0 0 24 24" fill="white"><path d="M3.9 12c0-1.7 1.4-3.1 3.1-3.1h4V7H7c-2.8 0-5 2.2-5 5s2.2 5 5 5h4v-1.9H7c-1.7 0-3.1-1.4-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.7 0 3.1 1.4 3.1 3.1s-1.4 3.1-3.1 3.1h-4V17h4c2.8 0 5-2.2 5-5s-2.2-5-5-5z"/></svg>
                    </div>
                    <span>è¤‡è£½é€£çµ</span>
                </div>
            </div>
            <button class="close-share" onclick="closeShareModal(event)">å–æ¶ˆ</button>
        </div>
    </div>

    <script>
        // ================= è¨­å®šå€ =================
        const MY_LIFF_ID = "2008941841-8KQq29wn"; 
        const WEBHOOK_URL = ""; 
        const SURVEYCAKE_URL = "https://www.surveycake.com/s/æ‚¨çš„å•å·ä»£ç¢¼"; 
        const SURVEY_UID_ALIAS = "line_uid"; 
        const FRAME_IMG_SRC = "./frame.png"; 
        
        // â˜… 5å¤§ä»»å‹™
        const TASKS = ['map', 'quiz', 'wish', 'beacon', 'bus'];

        const spotsData = {
            "spot1": { id: 1, title: "æ±æ­¢ç«è»Šç«™", img: "./spot1.jpg", desc: "æ±æ­¢çš„äº¤é€šå¿ƒè‡Ÿï¼Œä¹Ÿæ˜¯ç¾é£Ÿçš„ä¸€ç´šæˆ°å€ã€‚ç«™å‰å»£å ´ç¶“å¸¸èˆ‰è¾¦æ´»å‹•ï¼Œå‘¨é‚Šå··å¼„éš±è—è‘—è¨±å¤šåœ¨åœ°äººæ¨è–¦çš„å¤æ—©å‘³å°åƒã€‚é€™è£¡æ˜¯æ—…ç¨‹çš„èµ·é»ï¼Œå»ºè­°å…ˆåœ¨æ­¤è£œçµ¦æ°´åˆ†èˆ‡ç³§é£Ÿï¼Œæº–å‚™é–‹å§‹ä¸€å ´æ·±åº¦çš„åœ¨åœ°æ¢ç´¢ä¹‹æ—…ã€‚", query: "æ±æ­¢ç«è»Šç«™", hasBeacon: true },
            "spot2": { id: 2, title: "ä¸­æ­£è€è¡—", img: "./spot2.jpg", desc: "èˆŠç¨±ã€Œæ°´è¿”è…³è¡—ã€ï¼Œé€™è£¡æ˜¯æ±æ­¢æœ€æ—©çš„ç™¼æºåœ°ã€‚é›–ç„¶å•†æ¥­æ°£æ¯å·²æ·¡ï¼Œä½†èµ°åœ¨ç‹¹çª„çš„è¡—é“ä¸Šï¼Œä»èƒ½çœ‹è¦‹å¹¾æ£Ÿä¿ç•™å®Œæ•´çš„ç´…ç£šå¤åèˆ‡å‚³çµ±å¸‚å ´çš„ç†±é¬§å–§å›‚ï¼Œå½·å½¿ç©¿è¶Šå›ç™¾å¹´å‰ã€‚", query: "æ±æ­¢ä¸­æ­£è€è¡—", hasBeacon: false },
            "spot3": { id: 3, title: "è˜‡å®¶å¤å", img: "./spot3.jpg", desc: "éš±èº«æ–¼ç¾ä»£å»ºç¯‰ä¹‹ä¸­ï¼Œé€™åº§æ“æœ‰ç™¾å¹´æ­·å²çš„ç´…ç£šæ‹±å»Šå»ºç¯‰ï¼Œå±•ç¤ºäº†å„ªé›…çš„å·´æ´›å…‹å¼é¢¨æ ¼ã€‚å®ƒæ˜¯æ±æ­¢æœ›æ—è˜‡å®¶çš„å®…é‚¸ï¼Œè¦‹è­‰äº†ç•¶åœ°çš„èˆˆè¡°ï¼Œç´…ç£šç‰†ä¸Šçš„é›•èŠ±ä¾ç„¶æ¸…æ™°å¯è¦‹ã€‚", query: "æ±æ­¢è˜‡å®¶å¤å", hasBeacon: false },
            "spot4": { id: 4, title: "å»ºé †èŒ¶è¡Œ", img: "./spot4.jpg", desc: "æ±æ­¢æ›¾æ˜¯åŒ—å°ç£é‡è¦çš„èŒ¶è‘‰é›†æ•£åœ°ã€‚å»ºé †èŒ¶è¡Œå‚³æ‰¿ç™¾å¹´ï¼Œåº—å…§è‡³ä»Šä»ä¿ç•™è‘—å‚³çµ±çš„è£½èŒ¶å·¥å…·èˆ‡æªœæœ¨èŒ¶ç®±ï¼Œä¸€èµ°é€²å»å°±èƒ½èåˆ°æ¿ƒéƒçš„èŒ¶é¦™ï¼Œè€é—†ä¹Ÿå¸¸ç†±æƒ…è§£èªªèŒ¶è‘‰çŸ¥è­˜ã€‚", query: "æ±æ­¢å»ºé †èŒ¶è¡Œ", hasBeacon: true },
            "spot5": { id: 5, title: "èŒ„è‹³è…³éµè·¯éºè·¡", img: "./spot5.jpg", desc: "ä½æ–¼é«˜æ¶éµè·¯ä¸‹æ–¹ï¼Œé€™è£¡ä¿ç•™äº†æ¸…æœè‡³æ—¥æ²»æ™‚æœŸçš„éµè·¯åŸºåº§éºè·¡ã€‚çœ‹è‘—æ–‘é§çš„çŸ³å¡Šï¼Œå½·å½¿èƒ½è½è¦‹ç™¾å¹´å‰ç«è»Šè½Ÿéš†é§›éçš„è²éŸ³ï¼Œæ˜¯éµé“è¿·ä¸å¯éŒ¯éçš„éš±è—æ™¯é»ã€‚", query: "æ±æ­¢èŒ„è‹³è…³éµè·¯éºè¹Ÿ", hasBeacon: false },
            "spot6": { id: 6, title: "äº”å µéš§é“", img: "./spot6.jpg", desc: "é€™æ˜¯ä¸€åº§ç©¿è¶Šæ™‚ç©ºçš„éš§é“ã€‚åŸæœ¬æ˜¯èˆŠç«è»Šéš§é“ï¼Œè’å»¢å¤šå¹´å¾Œæ”¹å»ºç‚ºè‡ªè¡Œè»Šé“ã€‚ä¿ç•™äº†ç‡»é»‘çš„ç´…ç£šç‰†èˆ‡å¾©å¤ç‡ˆå…‰ï¼Œé¨è¡Œå…¶ä¸­åˆ¥æœ‰ä¸€ç•ªé¢¨å‘³ï¼Œå½·å½¿é€²å…¥äº†ç¥éš±å°‘å¥³çš„å ´æ™¯ã€‚", query: "äº”å µå°éµèˆŠéš§é“", hasBeacon: false },
            "spot7": { id: 7, title: "æ˜Ÿå…‰æ©‹", img: "./spot7.jpg", desc: "æ©«è·¨åŸºéš†æ²³çš„å–®æ–œå¡”æ™¯è§€æ©‹ï¼Œé€ å‹åƒä¸€æ”¯å·¨å¤§çš„éº¥å…‹é¢¨ã€‚ç™½å¤©è¦–é‡é–‹é—Šï¼Œå¯ä»¥é çœºç¾¤å±±ï¼Œå¤œæ™šé»ç‡ˆå¾Œå…‰å½±è®Šå¹»ï¼Œæ˜¯æ”å½±æ„›å¥½è€…èˆ‡æƒ…ä¾¶æ•£æ­¥çš„ç†±é–€æ™¯é»ã€‚", query: "æ±æ­¢æ˜Ÿå…‰æ©‹", hasBeacon: true },
            "spot8": { id: 8, title: "æ˜Ÿåº§å…¬åœ’", img: "./spot8.jpg", desc: "ä»¥12æ˜Ÿåº§ç‚ºä¸»é¡Œçš„å¤§å‹æ²³æ¿±å…¬åœ’ï¼Œè¨­æœ‰æ²™å‘ã€éŠæ¨‚è¨­æ–½èˆ‡å»£å¤§çš„è‰çš®ã€‚é€™è£¡æ˜¯è¦ªå­åŒæ¨‚çš„å¤©å ‚ï¼Œä¹Ÿæ˜¯é€™è¶Ÿæ—…ç¨‹å®Œç¾çš„ä¼‘æ­¢ç¬¦ï¼Œé©åˆåœ¨æ­¤é‡é¤ä¼‘æ¯ã€‚", query: "æ±æ­¢æ˜Ÿåº§å…¬åœ’", hasBeacon: false }
        };

        let pendingTask = null; 
        let leaveTime = 0; 

        window.onload = function() {
            liff.init({ liffId: MY_LIFF_ID }).then(() => {
                if (!liff.isLoggedIn()) {
                    liff.login();
                } else {
                    updateSurveyLink(); 
                    renderContent();
                }
            }).catch(err => { console.error(err); renderContent(); });
        };

        function updateSurveyLink() {
            let userId = "";
            try { if (liff.isLoggedIn()) userId = liff.getContext().userId; } catch (e) {}
            if (userId) {
                const finalUrl = `${SURVEYCAKE_URL}?${SURVEY_UID_ALIAS}=${userId}`;
                const btn = document.querySelector('.survey-btn');
                if (btn) btn.href = finalUrl;
            }
        }

        document.addEventListener("visibilitychange", () => {
            if (document.visibilityState === 'visible' && pendingTask && leaveTime > 0) {
                const duration = Math.round((Date.now() - leaveTime) / 1000);
                trackDuration(pendingTask, duration);
                leaveTime = 0;
                pendingTask = null;
            }
        });

        function initBeaconSimulation() {
            setTimeout(() => {
                const banner = document.getElementById('beacon-banner');
                banner.classList.add('show');
                setTimeout(() => {
                    banner.classList.remove('show');
                }, 8000);
            }, 3000);
        }

        // â˜… ä»»å‹™4ï¼šBeacon
        function handleBeaconClick() {
            const banner = document.getElementById('beacon-banner');
            banner.classList.remove('show'); 
            alert("ğŸ‰ æ­å–œï¼æ‚¨æ‰¾åˆ°äº†éš±è—è¨Šè™Ÿï¼\nç²å¾—ã€å°‹å¯¶å°ç« ã€‘");
            collectAction('beacon'); 
        }

        // â˜… ä»»å‹™2ï¼šçŸ¥è­˜å•ç­”
        function triggerQuiz() {
            if(isTaskDone('quiz')) return;
            const answer = confirm("ã€å°çŸ¥è­˜æŒ‘æˆ°ã€‘\nè«‹å•é€™è£¡æ˜¯ä¸æ˜¯æ±æ­¢è‘—åçš„æ­·å²æ™¯é»ï¼Ÿ\n\n(æ˜¯è«‹æŒ‰ã€Œç¢ºå®šã€ï¼Œå¦è«‹æŒ‰ã€Œå–æ¶ˆã€)");
            if(answer) {
                alert("â­• ç­”å°äº†ï¼ç²å¾—ã€å•ç­”å°ç« ã€‘");
                collectAction('quiz');
            } else {
                alert("âŒ ç­”éŒ¯å›‰ï¼å†ä»”ç´°çœ‹çœ‹ä»‹ç´¹å§ï¼");
            }
        }

        // â˜… ä»»å‹™3ï¼šé¡˜æœ›æ¸…å–® (æ›´æ–°ï¼šæ„›å¿ƒè®Šè‰²é‚è¼¯)
        function triggerWishlist() {
            const btn = document.getElementById('wish-btn');
            
            // è¦–è¦ºåˆ‡æ›
            if(btn.classList.contains('active')) {
                // å·²æ”¶è— -> å–æ¶ˆ (ä¸å–æ¶ˆå°ç« ï¼Œåªå–æ¶ˆè¦–è¦º)
                btn.classList.remove('active');
                btn.innerHTML = 'â™¡';
                alert("å·²å¾æ¸…å–®ç§»é™¤");
            } else {
                // æœªæ”¶è— -> æ”¶è—
                btn.classList.add('active');
                btn.innerHTML = 'â¤ï¸';
                
                if(!isTaskDone('wish')) {
                    alert("å·²åŠ å…¥æœ€æ„›ï¼ç²å¾—ã€æƒ³å»å°ç« ã€‘");
                    collectAction('wish');
                } else {
                    alert("å·²åŠ å…¥æœ€æ„›ï¼");
                }
            }
        }

        function renderContent() {
            const urlParams = new URLSearchParams(window.location.search);
            const spotKey = urlParams.get('id') || 'spot1';
            const data = spotsData[spotKey];
            if (data) {
                document.getElementById('spot-index').innerText = data.id;
                document.getElementById('spot-title').innerText = data.title;
                document.getElementById('spot-desc').innerText = data.desc;
                document.getElementById('spot-img').src = data.img; 
                
                const mapQuery = encodeURIComponent(data.query);
                // ä»»å‹™1ï¼šåœ°åœ– (åº•éƒ¨æŒ‰éˆ•)
                document.getElementById('map-btn').href = `https://www.google.com/maps/search/?api=1&query=${mapQuery}`;
                document.getElementById('food-btn').href = `https://www.google.com/maps/search/?api=1&query=${mapQuery}+ç¾é£Ÿ`;

                // ä»»å‹™5ï¼šå…¬è»Š (å‹•æ…‹)
                const currentIdNum = parseInt(data.id);
                let nextSpotKey = 'spot' + (currentIdNum + 1);
                if (currentIdNum >= 8) nextSpotKey = 'spot1'; 
                const nextData = spotsData[nextSpotKey];
                const busBtn = document.getElementById('bus-btn');
                if (nextData) {
                    const routeUrl = `https://www.google.com/maps/dir/?api=1&origin=${encodeURIComponent(data.query)}&destination=${encodeURIComponent(nextData.query)}&travelmode=transit`;
                    busBtn.href = routeUrl;
                    busBtn.querySelector('.bus-label').innerText = `å»${nextData.title}`;
                }

                if (data.hasBeacon) initBeaconSimulation();

                initTaskProgress();
                document.getElementById('loading').style.display = 'none';
                document.getElementById('main-content').style.display = 'block';
            }
        }

        // é€šç”¨é›†ç« 
        function collectAction(taskName) {
            let collected = JSON.parse(localStorage.getItem('xizhi_action_stamps')) || [];
            if (!collected.includes(taskName)) {
                collected.push(taskName);
                localStorage.setItem('xizhi_action_stamps', JSON.stringify(collected));
                trackAction('collect_' + taskName);
                setTimeout(initTaskProgress, 500); 
            }
        }
        
        function handleClickWithTrack(taskName) {
            collectAction(taskName); 
            pendingTask = taskName;
            leaveTime = Date.now();
            trackAction('click_' + taskName);
        }

        // æª¢æŸ¥ä»»å‹™æ˜¯å¦å·²å®Œæˆ (ä¸è·³ Alert ç‰ˆ)
        function isTaskDone(taskName) {
            let collected = JSON.parse(localStorage.getItem('xizhi_action_stamps')) || [];
            return collected.includes(taskName);
        }

        function initTaskProgress() {
            let collected = JSON.parse(localStorage.getItem('xizhi_action_stamps')) || [];
            
            // 1. æ›´æ–° Grid ç‹€æ…‹
            TASKS.forEach(task => {
                const el = document.getElementById('stamp-' + task);
                if (collected.includes(task)) {
                    el.classList.add('active');
                    el.innerText = 'âœ“'; 
                } else {
                    el.classList.remove('active');
                    // é‚„åŸåœ–ç¤º
                    if(task==='map') el.innerText = 'ğŸ—ºï¸';
                    if(task==='quiz') el.innerText = 'â“';
                    if(task==='wish') el.innerText = 'â¤ï¸';
                    if(task==='beacon') el.innerText = 'ğŸ“¡';
                    if(task==='bus') el.innerText = 'ğŸšŒ';
                }
            });

            // 2. æ›´æ–°æ„›å¿ƒæŒ‰éˆ•è¦–è¦º (å¦‚æœåˆ‡æ›é é¢å›ä¾†)
            const wishBtn = document.getElementById('wish-btn');
            if(collected.includes('wish')) {
                wishBtn.classList.add('active');
                wishBtn.innerHTML = 'â¤ï¸';
            } else {
                wishBtn.classList.remove('active');
                wishBtn.innerHTML = 'â™¡';
            }

            document.getElementById('progress-text').innerText = `${collected.length}/5`;
            document.getElementById('progress-bar').style.width = `${(collected.length/5)*100}%`;
            
            if (collected.length >= 5) {
                document.getElementById('survey-box').style.display = 'block';
                document.getElementById('memorial-box').style.display = 'block';
            }
        }

        // --- ç›¸æ¡†åˆæˆ (ä¿®æ­£ä¸‹è¼‰) ---
        function handleImageUpload(e) {
            const file = e.target.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = function(event) {
                const img = new Image();
                img.onload = function() { drawCanvas(img); }
                img.src = event.target.result;
            }
            reader.readAsDataURL(file);
        }

        function drawCanvas(userImg) {
            const canvas = document.getElementById('result-canvas');
            const ctx = canvas.getContext('2d');
            const size = 1080;
            canvas.width = size;
            canvas.height = size;
            
            const scale = Math.max(size / userImg.width, size / userImg.height);
            const x = (size / 2) - (userImg.width / 2) * scale;
            const y = (size / 2) - (userImg.height / 2) * scale;
            ctx.drawImage(userImg, x, y, userImg.width * scale, userImg.height * scale);

            const frameImg = new Image();
            frameImg.onload = function() {
                ctx.drawImage(frameImg, 0, 0, size, size);
                
                // è½‰ç‚º Image é¡¯ç¤º
                const dataUrl = canvas.toDataURL("image/png");
                const finalImg = document.getElementById('final-img');
                finalImg.src = dataUrl;
                finalImg.style.display = "block";
                document.getElementById('download-msg').style.display = "block";
            }
            frameImg.src = FRAME_IMG_SRC;
        }

        // --- åˆ†äº«é‚è¼¯ ---
        function openShareModal() { document.getElementById('share-modal').style.display = 'flex'; }
        function closeShareModal(e) {
            if (e.target === document.getElementById('share-modal') || e.target.classList.contains('close-share')) {
                document.getElementById('share-modal').style.display = 'none';
            }
        }
        function shareTo(platform) { 
            const url = window.location.href;
            const title = document.getElementById('spot-title').innerText;
            const text = `æˆ‘æ­£åœ¨æ¢ç´¢æ±æ­¢æ·±åº¦å°è¦½ï¼š${title}ï¼Œå¿«ä¾†çœ‹çœ‹ï¼`;
            if (platform === 'line') window.location.href = `https://line.me/R/msg/text/?${encodeURIComponent(text + " " + url)}`;
            else if (platform === 'fb') window.open(`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(url)}`);
            else if (platform === 'copy') {
                if (navigator.clipboard) navigator.clipboard.writeText(url).then(() => alert("é€£çµå·²è¤‡è£½ï¼"));
                else {
                    const textArea = document.createElement("textarea");
                    textArea.value = url;
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand("Copy");
                    textArea.remove();
                    alert("é€£çµå·²è¤‡è£½ï¼");
                }
            } 
            else if (platform === 'ig') {
                if (navigator.clipboard) {
                    navigator.clipboard.writeText(url).then(() => {
                        alert("é€£çµå·²è¤‡è£½ï¼è«‹é–‹å•Ÿ Instagram ç™¼ä½ˆé™æ™‚å‹•æ…‹ã€‚");
                        window.location.href = "instagram://app";
                    });
                } else {
                    alert("è«‹æ‰‹å‹•è¤‡è£½ç¶²å€åˆ†äº«è‡³ Instagram");
                }
            }
            document.getElementById('share-modal').style.display = 'none';
        }

        function toggleDesc() {
            const container = document.getElementById('spot-desc-container');
            const btn = document.getElementById('read-more-btn');
            container.classList.toggle('expanded');
            if (container.classList.contains('expanded')) {
                btn.innerText = "â–² æ”¶èµ·ç°¡ä»‹";
                trackAction('expand_desc');
            } else {
                btn.innerText = "â–¼ äº†è§£æ›´å¤šæ•…äº‹";
            }
        }
        function resetProgress() { if(confirm("é‡ç½®ï¼Ÿ")) { localStorage.removeItem('xizhi_action_stamps'); location.reload(); } }

        function trackAction(actionName) { sendToWebhook(actionName, 0); }
        function trackDuration(taskName, seconds) { sendToWebhook("stay_on_" + taskName, seconds); }
        function sendToWebhook(action, durationVal) {
            if (!WEBHOOK_URL) return;
            let userId = "unknown";
            try { if (liff.isLoggedIn()) userId = liff.getContext().userId; } catch(e) {}
            const spotId = new URLSearchParams(window.location.search).get('id') || 'spot1';
            
            fetch(WEBHOOK_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    userId: userId, 
                    action: action, 
                    spot: spotId, 
                    duration: durationVal, 
                    timestamp: new Date().toISOString() 
                })
            }).catch(console.error);
        }
    </script>
</body>
</html>
