<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ±æ­¢æ·±åº¦å°è¦½</title>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        /* --- åŸºç¤è¨­å®š --- */
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; padding: 0; background-color: #f4f7f6; color: #333; padding-bottom: 90px; }
        
        /* --- é ‚éƒ¨é€²åº¦æ¢ --- */
        .progress-container { position: fixed; top: 0; left: 0; width: 100%; height: 6px; background: #e0e0e0; z-index: 2000; }
        .progress-bar { height: 100%; background: linear-gradient(90deg, #ff8a00, #e52e71); width: 0%; transition: width 0.5s ease; border-radius: 0 3px 3px 0; }

        /* --- Hero åœ–ç‰‡å€ --- */
        .hero-container { position: relative; width: 100%; height: 35vh; overflow: hidden; }
        .hero-img { width: 100%; height: 100%; object-fit: cover; }
        
        /* --- ä¸»è¦å…§å®¹å¡ç‰‡ --- */
        .content-card { position: relative; background: white; border-radius: 24px 24px 0 0; margin-top: -25px; padding: 25px; box-shadow: 0 -5px 20px rgba(0,0,0,0.05); min-height: 60vh; }
        
        h1 { margin: 0 0 5px 0; font-size: 24px; font-weight: 800; color: #2c3e50; }
        .sub-tag { display: inline-block; font-size: 12px; color: #888; background: #eee; padding: 3px 8px; border-radius: 4px; margin-bottom: 15px; }

        /* --- ç°¡ä»‹å€ --- */
        .desc-box { margin-bottom: 25px; position: relative; }
        .desc-text { font-size: 15px; line-height: 1.6; color: #555; max-height: 6.4em; overflow: hidden; transition: max-height 0.4s ease; }
        .desc-text.expanded { max-height: none; overflow: visible; } 
        .desc-mask { position: absolute; bottom: 0; left: 0; width: 100%; height: 30px; background: linear-gradient(to bottom, rgba(255,255,255,0), white); pointer-events: none; transition: opacity 0.3s; }
        .desc-text.expanded + .desc-mask { opacity: 0; }
        .read-more-btn { display: block; width: 100%; text-align: center; padding-top: 10px; color: #007bff; font-weight: bold; font-size: 13px; cursor: pointer; }

        /* --- äº¤é€šå·¥å…·ç®± --- */
        .transport-grid { display: flex; gap: 10px; margin-bottom: 20px; }
        .t-btn { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 4px; padding: 10px; border-radius: 12px; text-decoration: none; color: white; font-weight: bold; font-size: 13px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); transition: transform 0.1s; position: relative; overflow: hidden; }
        .t-btn:active { transform: scale(0.96); }
        .t-btn i { font-style: normal; font-size: 18px; }
        .bg-ubike { background: linear-gradient(135deg, #fce38a 0%, #f38181 100%); color: #555; }
        .bg-bus   { background: #3498db; }
        .bg-uber  { background: #2c3e50; } 

        /* --- äº’å‹•é›†ç« å€ --- */
        .game-section { background: #fff8e1; border: 2px dashed #ffc107; border-radius: 16px; padding: 20px; text-align: center; margin-bottom: 20px; }
        .game-title { font-weight: bold; color: #d35400; margin-bottom: 15px; font-size: 16px; }
        .task-grid { display: flex; justify-content: center; gap: 10px; margin-bottom: 10px; }
        .stamp-box { display: flex; flex-direction: column; align-items: center; gap: 5px; width: 50px; }
        .stamp { width: 35px; height: 35px; border-radius: 50%; background: #e0e0e0; color: #999; display: flex; align-items: center; justify-content: center; font-size: 16px; font-weight: bold; border: 2px solid #ddd; transition: all 0.3s; }
        .stamp.active { background: #ff512f; color: white; border-color: #ff512f; transform: scale(1.1); box-shadow: 0 3px 8px rgba(255, 81, 47, 0.3); }
        .stamp-label { font-size: 10px; color: #888; }
        .stamp.active + .stamp-label { color: #d35400; font-weight: bold; }

        /* --- FB åˆ†äº« --- */
        .fb-share-btn { width: 100%; padding: 14px; margin-top: 10px; background: #1877F2; color: white; border: none; border-radius: 12px; font-size: 16px; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; box-shadow: 0 4px 10px rgba(24, 119, 242, 0.3); text-decoration: none; }

        /* --- å•å·å€å¡Š --- */
        #survey-box { display: none; margin-top: 20px; animation: popUp 0.5s ease; }
        .survey-btn { display: block; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; text-align: center; padding: 16px; border-radius: 12px; text-decoration: none; font-weight: bold; box-shadow: 0 4px 15px rgba(118, 75, 162, 0.4); }
        @keyframes popUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* --- åº•éƒ¨å›ºå®šå°èˆª --- */
        .sticky-footer { position: fixed; bottom: 0; left: 0; width: 100%; background: white; padding: 10px 15px; box-sizing: border-box; display: flex; gap: 10px; box-shadow: 0 -4px 20px rgba(0,0,0,0.08); z-index: 1000; padding-bottom: max(10px, env(safe-area-inset-bottom)); }
        .footer-btn { flex: 1; padding: 12px; border-radius: 10px; text-align: center; text-decoration: none; font-weight: bold; font-size: 15px; display: flex; align-items: center; justify-content: center; gap: 6px; }
        .btn-map { background: #f1f3f5; color: #495057; }
        .btn-food { background: #ff6b6b; color: white; }

        /* --- å½ˆçª— (Modal) --- */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 5000; display: none; align-items: center; justify-content: center; animation: fadeIn 0.2s; }
        .modal-box { background: white; width: 80%; max-width: 320px; border-radius: 16px; padding: 25px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.2); animation: scaleIn 0.2s; }
        .modal-title { font-size: 18px; font-weight: bold; margin-bottom: 10px; color: #333; }
        .modal-desc { font-size: 14px; color: #666; margin-bottom: 20px; }
        .modal-btns { display: flex; gap: 10px; }
        .modal-btn { flex: 1; padding: 10px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; font-size: 14px; }
        .btn-cancel { background: #f1f3f5; color: #666; }
        .btn-confirm { background: #27ae60; color: white; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes scaleIn { from { transform: scale(0.9); } to { transform: scale(1); } }

        /* --- é‡ç½®èˆ‡è¼‰å…¥ --- */
        .reset-link { margin-top: 30px; text-align: center; font-size: 12px; color: #ccc; text-decoration: underline; cursor: pointer; }
        #loading { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; display: flex; align-items: center; justify-content: center; z-index: 3000; flex-direction: column; color: #888; }
    </style>
</head>
<body>

    <div id="loading"><div>â³ è¼‰å…¥ä¸­...</div></div>
    <div class="progress-container"><div id="progress-bar" class="progress-bar"></div></div>

    <div id="main-content" style="display: none;">
        <div class="hero-container"><img id="spot-img" class="hero-img" src="" alt="æ™¯é»åœ–ç‰‡"></div>
        <div class="content-card">
            <span class="sub-tag">æ±æ­¢æ·±åº¦å°è¦½ NO.<span id="spot-index">1</span></span>
            <h1 id="spot-title"></h1>
            <div class="desc-box">
                <div id="spot-desc-container" class="desc-text"><span id="spot-desc"></span></div>
                <div class="desc-mask"></div>
                <div id="read-more-btn" class="read-more-btn" onclick="toggleDesc()">â–¼ äº†è§£æ›´å¤šæ•…äº‹</div>
            </div>

            <div class="transport-grid">
                <a href="https://www.google.com/maps/search/YouBike/" target="_blank" class="t-btn bg-ubike" onclick="collectAction('ubike')"><i>ğŸš²</i> YouBike</a>
                <a href="https://www.google.com/maps/search/å…¬è»Šç«™/" target="_blank" class="t-btn bg-bus" onclick="collectAction('bus')"><i>ğŸšŒ</i> æ‰¾å…¬è»Š</a>
                <a href="https://m.uber.com/ul" target="_blank" class="t-btn bg-uber" onclick="collectAction('uber')"><i>ğŸš•</i> å« Uber</a>
            </div>

            <div class="game-section">
                <div class="game-title">ğŸ† åŠŸèƒ½æ¢ç´¢ä»»å‹™ (é€²åº¦: <span id="progress-text">0/5</span>)</div>
                <div class="task-grid">
                    <div class="stamp-box"><div class="stamp" id="stamp-ubike">ğŸš²</div><div class="stamp-label">YouBike</div></div>
                    <div class="stamp-box"><div class="stamp" id="stamp-bus">ğŸšŒ</div><div class="stamp-label">å…¬è»Š</div></div>
                    <div class="stamp-box"><div class="stamp" id="stamp-uber">ğŸš•</div><div class="stamp-label">Uber</div></div>
                    <div class="stamp-box"><div class="stamp" id="stamp-map">ğŸ“</div><div class="stamp-label">å¸¶æˆ‘å»</div></div>
                    <div class="stamp-box"><div class="stamp" id="stamp-food">ğŸ´</div><div class="stamp-label">ç¾é£Ÿ</div></div>
                </div>
                <div style="font-size: 12px; color:#888; margin-top:5px;">ğŸ’¡ è©¦è‘—ä½¿ç”¨å°èˆªæˆ–å°‹æ‰¾ç¾é£Ÿï¼Œè§£é–æ‰€æœ‰å°ç« ï¼</div>
            </div>

            <a href="https://www.facebook.com/sharer/sharer.php?u=https://caroldaunn.github.io/xizhi-tour/" target="_blank" class="fb-share-btn">ğŸ‘ æ‰“å¡ä¸¦åˆ†äº« (FB)</a>

            <div id="survey-box">
                <a href="https://forms.gle/æ‚¨çš„å•å·é€£çµ" target="_blank" class="survey-btn" onclick="trackAction('click_survey')">ğŸ“ ä»»å‹™é”æˆï¼é ˜å–å®Œè³½è­‰æ›¸</a>
                <p style="text-align: center; color: #888; font-size: 12px; margin-top: 8px;">å¡«å¯«å®Œç•¢å¯ç²å¾—æ±æ­¢ç¾é£Ÿå„ªæƒ åˆ¸</p>
            </div>
            <div class="reset-link" onclick="resetProgress()">â†º é‡ç½®æ¸¬è©¦é€²åº¦</div>
        </div>
    </div>

    <div class="sticky-footer">
        <a id="map-btn" href="#" class="footer-btn btn-map" target="_blank" onclick="handleClickWithConfirm('map')">ğŸ“ å¸¶æˆ‘å»</a>
        <a id="food-btn" href="#" class="footer-btn btn-food" target="_blank" onclick="handleClickWithConfirm('food')">ğŸ´ é™„è¿‘ç¾é£Ÿ</a>
    </div>

    <div id="confirm-modal" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-title">ä»»å‹™ç¢ºèª ğŸ§</div>
            <div id="modal-msg" class="modal-desc">æ‚¨æ˜¯å¦å·²ç¶“æ‰¾åˆ°æƒ³å»çš„åœ°æ–¹äº†ï¼Ÿ</div>
            <div class="modal-btns">
                <button class="modal-btn btn-cancel" onclick="closeModal(false)">é‚„æ²’</button>
                <button class="modal-btn btn-confirm" onclick="closeModal(true)">é¸å¥½äº†ï¼(é›†ç« )</button>
            </div>
        </div>
    </div>

    <script>
        const MY_LIFF_ID = "2008941841-8KQq29wn"; 
        const WEBHOOK_URL = ""; 
        const SURVEY_URL = "https://forms.gle/æ‚¨çš„å•å·é€£çµ"; 
        const TASKS = ['ubike', 'bus', 'uber', 'map', 'food'];

        const spotsData = {
            "spot1": { id: 1, title: "æ±æ­¢ç«è»Šç«™", img: "./spot1.jpg", desc: "æ±æ­¢çš„äº¤é€šå¿ƒè‡Ÿï¼Œä¹Ÿæ˜¯ç¾é£Ÿçš„ä¸€ç´šæˆ°å€ã€‚ç«™å‰å»£å ´ç¶“å¸¸èˆ‰è¾¦æ´»å‹•ï¼Œå‘¨é‚Šå··å¼„éš±è—è‘—è¨±å¤šåœ¨åœ°äººæ¨è–¦çš„å¤æ—©å‘³å°åƒã€‚é€™è£¡æ˜¯æ—…ç¨‹çš„èµ·é»ï¼Œå»ºè­°å…ˆåœ¨æ­¤è£œçµ¦æ°´åˆ†èˆ‡ç³§é£Ÿï¼Œæº–å‚™é–‹å§‹ä¸€å ´æ·±åº¦çš„åœ¨åœ°æ¢ç´¢ä¹‹æ—…ã€‚å‘¨é‚Šé‚„æœ‰è¨±å¤šæ­·å²æ‚ ä¹…çš„å»ºç¯‰èˆ‡æ–‡åŒ–æ™¯é»ç­‰å¾…æ‚¨çš„ç™¼æ˜ã€‚", query: "æ±æ­¢ç«è»Šç«™" },
            "spot2": { id: 2, title: "ä¸­æ­£è€è¡—", img: "./spot2.jpg", desc: "èˆŠç¨±ã€Œæ°´è¿”è…³è¡—ã€ï¼Œé€™è£¡æ˜¯æ±æ­¢æœ€æ—©çš„ç™¼æºåœ°ã€‚é›–ç„¶å•†æ¥­æ°£æ¯å·²æ·¡ï¼Œä½†èµ°åœ¨ç‹¹çª„çš„è¡—é“ä¸Šï¼Œä»èƒ½çœ‹è¦‹å¹¾æ£Ÿä¿ç•™å®Œæ•´çš„ç´…ç£šå¤åèˆ‡å‚³çµ±å¸‚å ´çš„ç†±é¬§å–§å›‚ï¼Œå½·å½¿ç©¿è¶Šå›ç™¾å¹´å‰ã€‚é€™è£¡çš„æ¯ä¸€å¡Šç£šç“¦éƒ½è¨´èªªè‘—ç•¶å¹´çš„ç¹è¯æ•…äº‹ã€‚", query: "æ±æ­¢ä¸­æ­£è€è¡—" },
            "spot3": { id: 3, title: "è˜‡å®¶å¤å", img: "./spot3.jpg", desc: "éš±èº«æ–¼ç¾ä»£å»ºç¯‰ä¹‹ä¸­ï¼Œé€™åº§æ“æœ‰ç™¾å¹´æ­·å²çš„ç´…ç£šæ‹±å»Šå»ºç¯‰ï¼Œå±•ç¤ºäº†å„ªé›…çš„å·´æ´›å…‹å¼é¢¨æ ¼ã€‚å®ƒæ˜¯æ±æ­¢æœ›æ—è˜‡å®¶çš„å®…é‚¸ï¼Œè¦‹è­‰äº†ç•¶åœ°çš„èˆˆè¡°ï¼Œç´…ç£šç‰†ä¸Šçš„é›•èŠ±ä¾ç„¶æ¸…æ™°å¯è¦‹ï¼Œæ˜¯æ”å½±æ„›å¥½è€…çµ•ä½³çš„å–æ™¯åœ°é»ã€‚", query: "æ±æ­¢è˜‡å®¶å¤å" },
            "spot4": { id: 4, title: "å»ºé †èŒ¶è¡Œ", img: "./spot4.jpg", desc: "æ±æ­¢æ›¾æ˜¯åŒ—å°ç£é‡è¦çš„èŒ¶è‘‰é›†æ•£åœ°ã€‚å»ºé †èŒ¶è¡Œå‚³æ‰¿ç™¾å¹´ï¼Œåº—å…§è‡³ä»Šä»ä¿ç•™è‘—å‚³çµ±çš„è£½èŒ¶å·¥å…·èˆ‡æªœæœ¨èŒ¶ç®±ï¼Œä¸€èµ°é€²å»å°±èƒ½èåˆ°æ¿ƒéƒçš„èŒ¶é¦™ï¼Œè€é—†ä¹Ÿå¸¸ç†±æƒ…è§£èªªèŒ¶è‘‰çŸ¥è­˜ï¼Œè®“æ‚¨æ·±å…¥äº†è§£å°ç£èŒ¶æ–‡åŒ–çš„ç²¾éš¨ã€‚", query: "æ±æ­¢å»ºé †èŒ¶è¡Œ" },
            "spot5": { id: 5, title: "èŒ„è‹³è…³éµè·¯éºè·¡", img: "./spot5.jpg", desc: "ä½æ–¼é«˜æ¶éµè·¯ä¸‹æ–¹ï¼Œé€™è£¡ä¿ç•™äº†æ¸…æœè‡³æ—¥æ²»æ™‚æœŸçš„éµè·¯åŸºåº§éºè·¡ã€‚çœ‹è‘—æ–‘é§çš„çŸ³å¡Šï¼Œå½·å½¿èƒ½è½è¦‹ç™¾å¹´å‰ç«è»Šè½Ÿéš†é§›éçš„è²éŸ³ï¼Œæ˜¯éµé“è¿·ä¸å¯éŒ¯éçš„éš±è—æ™¯é»ã€‚æ—é‚Šçš„å…¬åœ’ä¹Ÿæ˜¯ç•¶åœ°å±…æ°‘ä¼‘é–’çš„å¥½å»è™•ã€‚", query: "æ±æ­¢èŒ„è‹³è…³éµè·¯éºè¹Ÿ" },
            "spot6": { id: 6, title: "äº”å µéš§é“", img: "./spot6.jpg", desc: "é€™æ˜¯ä¸€åº§ç©¿è¶Šæ™‚ç©ºçš„éš§é“ã€‚åŸæœ¬æ˜¯èˆŠç«è»Šéš§é“ï¼Œè’å»¢å¤šå¹´å¾Œæ”¹å»ºç‚ºè‡ªè¡Œè»Šé“ã€‚ä¿ç•™äº†ç‡»é»‘çš„ç´…ç£šç‰†èˆ‡å¾©å¤ç‡ˆå…‰ï¼Œé¨è¡Œå…¶ä¸­åˆ¥æœ‰ä¸€ç•ªé¢¨å‘³ï¼Œå½·å½¿é€²å…¥äº†ç¥éš±å°‘å¥³çš„å ´æ™¯ã€‚éš§é“å…§æ¶¼çˆ½å®œäººï¼Œæ˜¯å¤æ—¥é¿æš‘çš„å¥½å»è™•ã€‚", query: "äº”å µå°éµèˆŠéš§é“" },
            "spot7": { id: 7, title: "æ˜Ÿå…‰æ©‹", img: "./spot7.jpg", desc: "æ©«è·¨åŸºéš†æ²³çš„å–®æ–œå¡”æ™¯è§€æ©‹ï¼Œé€ å‹åƒä¸€æ”¯å·¨å¤§çš„éº¥å…‹é¢¨ã€‚ç™½å¤©è¦–é‡é–‹é—Šï¼Œå¯ä»¥é çœºç¾¤å±±ï¼Œå¤œæ™šé»ç‡ˆå¾Œå…‰å½±è®Šå¹»ï¼Œæ˜¯æ”å½±æ„›å¥½è€…èˆ‡æƒ…ä¾¶æ•£æ­¥çš„ç†±é–€æ™¯é»ã€‚æ©‹ä¸Šè¨­æœ‰ä¼‘æ†©åº§æ¤…ï¼Œé©åˆç™¼å‘†å¹é¢¨ã€‚", query: "æ±æ­¢æ˜Ÿå…‰æ©‹" },
            "spot8": { id: 8, title: "æ˜Ÿåº§å…¬åœ’", img: "./spot8.jpg", desc: "ä»¥12æ˜Ÿåº§ç‚ºä¸»é¡Œçš„å¤§å‹æ²³æ¿±å…¬åœ’ï¼Œè¨­æœ‰æ²™å‘ã€éŠæ¨‚è¨­æ–½èˆ‡å»£å¤§çš„è‰çš®ã€‚é€™è£¡æ˜¯è¦ªå­åŒæ¨‚çš„å¤©å ‚ï¼Œä¹Ÿæ˜¯é€™è¶Ÿæ—…ç¨‹å®Œç¾çš„ä¼‘æ­¢ç¬¦ï¼Œé©åˆåœ¨æ­¤é‡é¤ä¼‘æ¯ã€‚å¤œæ™šæ™‚åˆ†ï¼Œé€™è£¡ä¹Ÿæ˜¯è§€æ˜Ÿçš„å¥½åœ°é»ã€‚", query: "æ±æ­¢æ˜Ÿåº§å…¬åœ’" }
        };

        let pendingTask = null; // æš«å­˜ç­‰å¾…ç¢ºèªçš„ä»»å‹™

        window.onload = function() {
            liff.init({ liffId: MY_LIFF_ID }).then(() => {
                if (!liff.isLoggedIn()) liff.login();
                else renderContent();
            }).catch(err => { renderContent(); });
        };

        // ç›£è½ç¶²é å¯è¦‹æ€§ (ç•¶ä½¿ç”¨è€…å¾ Google Maps å›ä¾†æ™‚è§¸ç™¼)
        document.addEventListener("visibilitychange", () => {
            if (document.visibilityState === 'visible' && pendingTask) {
                // å»¶é²ä¸€é»é»é¡¯ç¤ºï¼Œé¿å…ç¬é–“è·³å‡ºå¤ªçªå…€
                setTimeout(() => {
                    const msg = pendingTask === 'food' ? "æ‚¨é¸å¥½æƒ³åƒçš„é¤å»³äº†å—ï¼ŸğŸ˜‹" : "æ‚¨ç¢ºèªå¥½å‰å¾€è·¯ç·šäº†å—ï¼ŸğŸ—ºï¸";
                    document.getElementById('modal-msg').innerText = msg;
                    document.getElementById('confirm-modal').style.display = 'flex';
                }, 500);
            }
        });

        function renderContent() {
            const urlParams = new URLSearchParams(window.location.search);
            const spotKey = urlParams.get('id') || 'spot1';
            const data = spotsData[spotKey];
            if (data) {
                document.getElementById('spot-index').innerText = data.id;
                document.getElementById('spot-title').innerText = data.title;
                document.getElementById('spot-desc').innerText = data.desc;
                document.getElementById('spot-img').src = data.img; 
                
                // è¨­å®šé€£çµ
                document.getElementById('map-btn').href = `https://www.google.com/maps/search/?api=1&query={encodeURIComponent(data.query)}`;
                document.getElementById('food-btn').href = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(data.query + " ç¾é£Ÿ")}`;

                initTaskProgress();
                document.getElementById('loading').style.display = 'none';
                document.getElementById('main-content').style.display = 'block';
            }
        }

        // --- äº’å‹•é‚è¼¯ ---
        
        // 1. ç«‹å³é›†é» (UBike/Bus/Uber)
        function collectAction(taskName) {
            saveStamp(taskName);
        }

        // 2. å»¶é²é›†é» (Map/Food)
        function handleClickWithConfirm(taskName) {
            // è¨˜éŒ„ç›®å‰æ­£åœ¨é€²è¡Œçš„ä»»å‹™ï¼Œç­‰ä½¿ç”¨è€…å›ä¾†
            pendingTask = taskName;
        }

        // 3. è™•ç†å½ˆçª—çµæœ
        function closeModal(isConfirmed) {
            document.getElementById('confirm-modal').style.display = 'none';
            if (isConfirmed && pendingTask) {
                saveStamp(pendingTask);
                alert("é›†ç« æˆåŠŸï¼ç²å¾— 1 æšå°ç«  ğŸ’®");
            }
            pendingTask = null; // æ¸…é™¤æš«å­˜
        }

        // 4. å¯«å…¥å„²å­˜èˆ‡æ›´æ–° UI
        function saveStamp(taskName) {
            let collected = JSON.parse(localStorage.getItem('xizhi_action_stamps')) || [];
            if (!collected.includes(taskName)) {
                collected.push(taskName);
                localStorage.setItem('xizhi_action_stamps', JSON.stringify(collected));
                trackAction('collect_' + taskName);
                initTaskProgress();
            }
        }

        function initTaskProgress() {
            let collected = JSON.parse(localStorage.getItem('xizhi_action_stamps')) || [];
            TASKS.forEach(task => {
                const el = document.getElementById('stamp-' + task);
                if (collected.includes(task)) {
                    el.classList.add('active');
                    el.innerText = 'âœ“';
                } else {
                    el.classList.remove('active');
                    if(task==='ubike') el.innerText = 'ğŸš²';
                    if(task==='bus') el.innerText = 'ğŸšŒ';
                    if(task==='uber') el.innerText = 'ğŸš•';
                    if(task==='map') el.innerText = 'ğŸ“';
                    if(task==='food') el.innerText = 'ğŸ´';
                }
            });
            document.getElementById('progress-text').innerText = `${collected.length}/5`;
            document.getElementById('progress-bar').style.width = `${(collected.length/5)*100}%`;
            if (collected.length >= 5) document.getElementById('survey-box').style.display = 'block';
        }

        function toggleDesc() {
            const container = document.getElementById('spot-desc-container');
            const btn = document.getElementById('read-more-btn');
            const mask = document.querySelector('.desc-mask');
            container.classList.toggle('expanded');
            if (container.classList.contains('expanded')) {
                btn.innerText = "â–² æ”¶èµ·ç°¡ä»‹";
                mask.style.opacity = '0'; 
                trackAction('expand_desc');
            } else {
                btn.innerText = "â–¼ äº†è§£æ›´å¤šæ•…äº‹";
                mask.style.opacity = '1'; 
            }
        }

        function resetProgress() {
            if(confirm("é‡ç½®æ¸¬è©¦é€²åº¦ï¼Ÿ")) {
                localStorage.removeItem('xizhi_action_stamps');
                location.reload();
            }
        }

        function trackAction(actionName) {
            if (!WEBHOOK_URL) return;
            const spotId = new URLSearchParams(window.location.search).get('id') || 'spot1';
            let userId = "unknown";
            try { userId = liff.getContext().userId; } catch(e) {}
            fetch(WEBHOOK_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ userId: userId, action: actionName, spot: spotId, timestamp: new Date().toISOString() })
            }).catch(console.error);
        }
    </script>
</body>
</html>
