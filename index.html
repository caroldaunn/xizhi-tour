<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ±æ­¢åœ¨åœ°è³‡è¨Š</title>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        /* --- åŸºç¤è¨­å®š --- */
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; padding: 0; background-color: #f4f7f6; color: #333; padding-bottom: 100px; }
        
        /* ä¸€èˆ¬æ¨¡å¼ï¼šé€²åº¦æ¢é¡¯ç¤º */
        .progress-container { position: fixed; top: 0; left: 0; width: 100%; height: 6px; background: #e0e0e0; z-index: 2000; }
        .progress-bar { height: 100%; background: linear-gradient(90deg, #ff8a00, #e52e71); width: 0%; transition: width 0.5s ease; border-radius: 0 3px 3px 0; }

        /* ä¸€èˆ¬æ¨¡å¼ï¼šBeacon */
        .beacon-banner { position: fixed; top: -120px; left: 5%; width: 90%; background: rgba(34, 34, 34, 0.95); color: white; padding: 12px 15px; border-radius: 50px; box-shadow: 0 8px 20px rgba(0,0,0,0.3); z-index: 5000; display: flex; align-items: center; gap: 12px; transition: top 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275); cursor: pointer; box-sizing: border-box; }
        .beacon-banner.show { top: 20px; } 
        .beacon-icon { width: 36px; height: 36px; background: #06C755; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 20px; flex-shrink: 0; }
        .beacon-text { flex: 1; font-size: 13px; line-height: 1.3; }
        .beacon-title { font-weight: bold; color: #fff; font-size: 14px; }
        .beacon-sub { color: #ccc; font-size: 11px; }

        .hero-container { position: relative; width: 100%; height: 35vh; overflow: hidden; }
        .hero-img { width: 100%; height: 100%; object-fit: cover; }
        
        .content-card { position: relative; background: white; border-radius: 24px 24px 0 0; margin-top: -25px; padding: 25px; box-shadow: 0 -5px 20px rgba(0,0,0,0.05); min-height: 60vh; }
        
        .title-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
        h1 { margin: 0; font-size: 24px; font-weight: 800; color: #2c3e50; }
        .wish-btn { font-size: 22px; color: #ccc; cursor: pointer; transition: transform 0.2s; padding: 5px; }
        .wish-btn.active { color: #ff4757; transform: scale(1.1); }

        .sub-tag { display: inline-block; font-size: 12px; color: #fff; background: #2c3e50; padding: 4px 10px; border-radius: 4px; margin-bottom: 10px; font-weight: bold; }
        .route-info { font-size: 13px; color: #666; margin-bottom: 10px; border-left: 3px solid #ff8a00; padding-left: 8px; line-height: 1.4; }
        .spot-number { font-size: 12px; color: #888; margin-bottom: 15px; font-weight: bold; background: #f0f0f0; display: inline-block; padding: 2px 8px; border-radius: 10px; }

        .desc-box { margin-bottom: 25px; border-bottom: 1px solid #eee; padding-bottom: 15px; }
        .desc-text { font-size: 15px; line-height: 1.6; color: #555; max-height: 8.0em; overflow: hidden; transition: max-height 0.4s ease; margin-bottom: 12px; }
        .desc-text.expanded { max-height: none; overflow: visible; } 
        
        .desc-actions { display: flex; justify-content: space-between; align-items: center; }
        .read-more-btn { color: #007bff; font-weight: bold; font-size: 14px; cursor: pointer; text-decoration: underline; }
        
        .quiz-trigger-btn { background: #ff9f43; color: white; padding: 6px 14px; border-radius: 20px; font-size: 13px; font-weight: bold; cursor: pointer; display: flex; align-items: center; gap: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }

        .transport-grid { display: flex; gap: 10px; margin-bottom: 20px; }
        .t-btn { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 4px; padding: 10px; border-radius: 12px; text-decoration: none; color: white; font-weight: bold; font-size: 13px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); transition: transform 0.1s; position: relative; overflow: hidden; text-align: center; }
        .t-btn:active { transform: scale(0.96); }
        .t-btn i { font-style: normal; font-size: 18px; display: block; margin-bottom: 2px;}
        .bg-ubike { background: linear-gradient(135deg, #fce38a 0%, #f38181 100%); color: #555; }
        .bg-bus   { background: #3498db; }
        .bg-parking { background: #546de5; } 
        .bus-label { font-size: 11px; opacity: 0.9; line-height: 1.2; }

        .game-section { background: #fff8e1; border: 2px dashed #ffc107; border-radius: 16px; padding: 20px; text-align: center; margin-bottom: 15px; }
        .game-title { font-weight: bold; color: #d35400; margin-bottom: 15px; font-size: 16px; }
        .task-grid { display: flex; justify-content: center; gap: 10px; margin-bottom: 10px; }
        .stamp-box { display: flex; flex-direction: column; align-items: center; gap: 5px; width: 55px; }
        .stamp { width: 40px; height: 40px; border-radius: 50%; background: #e0e0e0; color: #777; display: flex; align-items: center; justify-content: center; font-size: 18px; font-weight: bold; border: 2px solid #ddd; transition: all 0.3s; }
        .stamp.active { background: #ff512f; color: white; border-color: #ff512f; transform: scale(1.1); box-shadow: 0 3px 8px rgba(255, 81, 47, 0.3); }
        .stamp-label { font-size: 10px; color: #888; margin-top: 4px; font-weight: bold;}

        .share-text-link { text-align: center; margin: 15px 0; font-size: 15px; font-weight: bold; color: #555; cursor: pointer; text-decoration: underline; display: block; }

        #survey-box { display: none; margin-top: 25px; animation: popUp 0.5s ease; padding-top: 20px; border-top: 1px solid #eee; }
        .survey-btn { display: block; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; text-align: center; padding: 16px; border-radius: 12px; text-decoration: none; font-weight: bold; box-shadow: 0 4px 15px rgba(118, 75, 162, 0.4); }

        #memorial-box { display: none; margin-top: 25px; text-align: center; background: #fafafa; padding: 20px; border-radius: 12px; }
        .memorial-title { font-size: 16px; font-weight: 800; color: #2c3e50; margin-bottom: 5px; }
        .memorial-desc { font-size: 13px; color: #666; margin-bottom: 15px; }
        .upload-btn-wrapper { position: relative; overflow: hidden; display: inline-block; margin-bottom: 15px; }
        .btn-upload { border: 2px dashed #007bff; color: #007bff; background-color: white; padding: 8px 16px; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 14px; }
        .upload-btn-wrapper input[type=file] { font-size: 100px; position: absolute; left: 0; top: 0; opacity: 0; cursor: pointer; }
        #result-canvas { display: none; }
        #final-img { width: 100%; max-width: 280px; border: 2px solid #28a745; box-shadow: 0 4px 15px rgba(0,0,0,0.2); display: none; margin: 10px auto; border-radius: 8px; pointer-events: auto; }
        .download-hint { display: none; color: #28a745; font-weight: bold; font-size: 14px; margin-top: 10px; background: #e8f5e9; padding: 10px; border-radius: 8px;}
        
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 6000; display: none; align-items: flex-end; justify-content: center; animation: fadeIn 0.2s; }
        .share-sheet { width: 100%; max-width: 500px; background: white; border-radius: 20px 20px 0 0; padding: 25px 25px 35px 25px; box-sizing: border-box; animation: slideUp 0.3s; }
        .share-title { font-size: 16px; font-weight: bold; color: #333; margin-bottom: 25px; text-align: center; }
        .share-grid { display: flex; justify-content: space-around; gap: 10px; }
        .share-item { display: flex; flex-direction: column; align-items: center; gap: 10px; cursor: pointer; color: #555; font-size: 12px; width: 70px; }
        .share-icon-box { width: 52px; height: 52px; border-radius: 14px; display: flex; align-items: center; justify-content: center; transition: transform 0.2s; color: white; }
        .share-item:active .share-icon-box { transform: scale(0.92); }
        .share-icon-box svg { width: 30px; height: 30px; fill: currentColor; }
        
        .quiz-box { background: white; width: 85%; max-width: 320px; padding: 20px; border-radius: 16px; text-align: center; position: relative; align-self: center; }
        .quiz-question { font-size: 16px; font-weight: bold; margin-bottom: 20px; color: #333; line-height: 1.5; }
        .quiz-options { display: flex; flex-direction: column; gap: 10px; }
        .quiz-btn { padding: 12px; border: 1px solid #ddd; background: #f8f9fa; border-radius: 8px; font-size: 14px; cursor: pointer; transition: background 0.2s; }
        .quiz-btn:active { background: #e2e6ea; }
        .close-modal { margin-top: 15px; color: #999; font-size: 12px; text-decoration: underline; cursor: pointer; }

        .sticky-footer { position: fixed; bottom: 0; left: 0; width: 100%; background: white; padding: 10px 15px; box-sizing: border-box; display: flex; gap: 10px; box-shadow: 0 -4px 20px rgba(0,0,0,0.08); z-index: 1000; padding-bottom: max(10px, env(safe-area-inset-bottom)); }
        .footer-btn { flex: 1; padding: 12px; border-radius: 10px; text-align: center; text-decoration: none; font-weight: bold; font-size: 15px; display: flex; align-items: center; justify-content: center; gap: 6px; }
        .btn-map { background: #f1f3f5; color: #495057; }
        .btn-food { background: #ff6b6b; color: white; }

        .reset-link { margin-top: 30px; text-align: center; font-size: 12px; color: #ccc; text-decoration: underline; cursor: pointer; }
        #loading { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; display: flex; align-items: center; justify-content: center; z-index: 3000; flex-direction: column; color: #888; }

        /* ==========================================================================
           [é—œéµ] æ´»å‹•æ¨¡å¼å°ˆç”¨ CSS (Activity Mode)
           ç•¶ body æœ‰ .activity-mode class æ™‚ï¼Œå¼·åˆ¶éš±è—æ‰€æœ‰äº’å‹•/æŒ‘æˆ°å…ƒç´ ï¼Œ
           åªä¿ç•™åœ–ç‰‡ã€æ¨™é¡Œã€èªªæ˜æ–‡ã€åŸºç¤äº¤é€š(YouBike/åœè»Šå ´) èˆ‡ åˆ†äº«ã€‚
           ========================================================================== */
        body.activity-mode .game-section,       /* éš±è—é›†ç« æŒ‘æˆ° */
        body.activity-mode .quiz-trigger-btn,   /* éš±è—çŸ¥è­˜å•ç­”æŒ‰éˆ• */
        body.activity-mode .beacon-banner,      /* éš±è— Beacon æ©«å¹… */
        body.activity-mode #wish-btn,           /* éš±è—æ„›å¿ƒæ”¶è— */
        body.activity-mode #survey-box,         /* éš±è—å•å·å€ */
        body.activity-mode #memorial-box,       /* éš±è—ç´€å¿µç…§å€ */
        body.activity-mode .progress-container, /* éš±è—é ‚éƒ¨é€²åº¦æ¢ */
        body.activity-mode .reset-link,         /* éš±è—é‡ç½®é€£çµ */
        body.activity-mode #spot-number,        /* éš±è—ç¬¬Xç«™è³‡è¨Š */
        body.activity-mode #bus-btn,            /* éš±è—å»ä¸‹ä¸€ç«™(å…¬è»Š)æŒ‰éˆ• */
        body.activity-mode .read-more-btn {     /* éš±è—å±•é–‹/æ”¶èµ·æŒ‰éˆ• */
            display: none !important;
        }

        /* æ´»å‹•æ¨¡å¼ä¸‹ï¼Œèªªæ˜æ–‡å­—å­—é«”åŠ å¤§ï¼Œä¸¦ä¸”å¼·åˆ¶å…¨å±•é–‹ */
        body.activity-mode .desc-text { 
            font-size: 16px; 
            line-height: 1.8; 
            color: #222; 
            max-height: none !important; /* å¼·åˆ¶å–æ¶ˆé«˜åº¦é™åˆ¶ */
            overflow: visible !important;
        }
    </style>
</head>
<body>

    <div id="loading"><div>â³ è¼‰å…¥ä¸­...</div></div>
    <div class="progress-container"><div id="progress-bar" class="progress-bar"></div></div>

    <div id="beacon-banner" class="beacon-banner" onclick="handleBeaconClick()">
        <div class="beacon-icon">ğŸ“¡</div>
        <div class="beacon-text">
            <div class="beacon-title">åµæ¸¬åˆ° LINE Beacon è¨Šè™Ÿ</div>
            <div class="beacon-sub">é™„è¿‘æœ‰éš±è—æ™¯é»ï¼é»æ“Šæ‰“å¡</div>
        </div>
    </div>

    <div id="main-content" style="display: none;">
        <div class="hero-container"><img id="spot-img" class="hero-img" src="" alt="æ™¯é»åœ–ç‰‡"></div>
        <div class="content-card">
            <span id="route-tag" class="sub-tag">æ±æ­¢è³‡è¨Š</span>
            <div id="route-desc" class="route-info"></div>
            <div id="spot-number" class="spot-number"></div>
            
            <div class="title-row">
                <h1 id="spot-title"></h1>
                <div id="wish-btn" class="wish-btn" onclick="triggerWishlist()">â™¡</div>
            </div>
            
            <div class="desc-box">
                <div id="spot-desc-container" class="desc-text"><span id="spot-desc"></span></div>
                <div class="desc-actions">
                    <div id="read-more-btn" class="read-more-btn" onclick="toggleDesc()">â–¼ äº†è§£æ›´å¤šæ•…äº‹</div>
                    <div class="quiz-trigger-btn" onclick="openQuizModal()">
                        <span>ğŸ§  çŸ¥è­˜å°å­¸å ‚</span>
                    </div>
                </div>
            </div>

            <div class="transport-grid">
                <a href="#" target="_blank" class="t-btn bg-ubike" onclick="trackAction('click_ubike')">
                    <i>ğŸš²</i> YouBike
                </a>
                <a id="bus-btn" href="#" target="_blank" class="t-btn bg-bus" onclick="collectAction('bus')">
                    <i>ğŸšŒ</i> <span class="bus-label">å»ä¸‹ä¸€ç«™</span>
                </a>
                <a id="parking-btn" href="#" target="_blank" class="t-btn bg-parking" onclick="trackAction('click_parking')">
                    <i>ğŸ…¿ï¸</i> æ‰¾åœè»Šå ´
                </a>
            </div>

            <div style="text-align: center; margin-bottom: 20px;">
                <a href="https://www.xizhi.ntpc.gov.tw/home.jsp?id=1ee324bfb5e44418" target="_blank" style="font-size: 12px; color: #999; text-decoration: underline;">
                    ğŸ“„ Fç³»åˆ—ç¤¾å€å·´å£«æ™‚åˆ»è¡¨
                </a>
            </div>

            <div class="game-section">
                <div class="game-title">ğŸ† æ±æ­¢é”äººæŒ‘æˆ° (é€²åº¦: <span id="progress-text">0/5</span>)</div>
                <div class="task-grid">
                    <div class="stamp-box"><div class="stamp" id="stamp-map">ğŸ—ºï¸</div><div class="stamp-label">æ‰¾è·¯</div></div>
                    <div class="stamp-box"><div class="stamp" id="stamp-quiz">â“</div><div class="stamp-label">å•ç­”</div></div>
                    <div class="stamp-box"><div class="stamp" id="stamp-wish">â¤ï¸</div><div class="stamp-label">æƒ³å»</div></div>
                    <div class="stamp-box"><div class="stamp" id="stamp-beacon">ğŸ“¡</div><div class="stamp-label">å°‹å¯¶</div></div>
                    <div class="stamp-box"><div class="stamp" id="stamp-bus">ğŸšŒ</div><div class="stamp-label">äº¤é€š</div></div>
                </div>
                <div style="font-size: 12px; color:#888; margin-top:5px;">ğŸ’¡ è«‹å¾é é¢å„è™•å°‹æ‰¾äº’å‹•æ©Ÿæœƒï¼Œå®Œæˆä¸Šæ–¹æŒ‘æˆ°ï¼</div>
            </div>

            <div class="share-text-link" onclick="openShareModal()">ğŸ“¤ è¦ºå¾—ä¸éŒ¯ï¼Ÿæ‰“å¡ä¸¦åˆ†äº«çµ¦å¥½å‹</div>

            <div id="survey-box">
                <a href="#" target="_blank" class="survey-btn" onclick="trackAction('click_survey')">ğŸ“ ä»»å‹™é”æˆï¼å¡«å¯«å•å·é ˜å–è­‰æ›¸</a>
            </div>

            <div id="memorial-box">
                <div class="memorial-title">ğŸ é¡å¤–çå‹µï¼šå®Œè³½ç´€å¿µç…§</div>
                <p class="memorial-desc">ä¸Šå‚³è‡ªæ‹ç…§ï¼Œåˆæˆæ±æ­¢é”äººç›¸æ¡†ï¼</p>
                <div class="upload-btn-wrapper">
                    <button class="btn-upload">ğŸ“¸ é¸æ“‡ç…§ç‰‡ / é–‹å•Ÿç›¸æ©Ÿ</button>
                    <input type="file" id="upload-input" accept="image/*" onchange="handleImageUpload(event)">
                </div>
                <canvas id="result-canvas"></canvas>
                <img id="final-img" src="" alt="åˆæˆç…§ç‰‡">
                <div id="download-msg" class="download-hint">ğŸ‘† è«‹ã€Œé•·æŒ‰ä¸Šæ–¹åœ–ç‰‡ã€å„²å­˜è‡³æ‰‹æ©Ÿç›¸ç°¿</div>
            </div>

            <div class="reset-link" onclick="resetProgress()">â†º é‡ç½®æ¸¬è©¦é€²åº¦</div>
        </div>
    </div>

    <div class="sticky-footer">
        <a id="map-btn" href="#" class="footer-btn btn-map" target="_blank" onclick="handleClickWithTrack('map')">ğŸ“ å¸¶æˆ‘å»</a>
        <a id="food-btn" href="#" class="footer-btn btn-food" target="_blank" onclick="trackAction('click_food')">ğŸ´ é™„è¿‘ç¾é£Ÿ</a>
    </div>

    <div id="share-modal" class="modal-overlay" onclick="closeModal('share-modal', event)">
        <div class="share-sheet">
            <div class="share-title">åˆ†äº«é€™å€‹è³‡è¨Š ğŸ“¢</div>
            <div class="share-grid">
                <div class="share-item" onclick="shareTo('line')"><div class="share-icon-box" style="background:#06C755;"><svg viewBox="0 0 24 24"><path d="M22 10.3c0-4.7-4.3-8.6-10-8.6-5.4 0-10 3.9-10 8.6 0 4.2 3.8 7.8 8.4 8.5.3 0 .7.2.8.5 0 0 .3 1.1.3 1.3-.1.5-.4 1.8-1.7 2.5 1.4 0 4.3-.9 6-3.1 3.5-1.5 6.2-4.8 6.2-9.7zm-14.7.2c0-.3.3-.5.5-.5h4.8c.3 0 .5.2.5.5s-.2.5-.5.5h-4.2v1.3h4.2c.3 0 .5.2.5.5s-.2.5-.5.5h-4.8c-.3 0-.5-.2-.5-.5v-2.1zm8.7 2.1c0 .3-.2.5-.5.5h-1.3v-2.6h.5c.3 0 .5.2.5.5v2.1c.8 0 .8-.5.8-2.6h.6v2.6c0 .3-.2.5-.6.5h-.1zm-2.8-2.6h.5c.3 0 .5.2.5.5v1.3l1.8-1.8h.7l-1.9 1.9 2 2.1h-.7l-1.6-1.7v1.7c0 .3-.2.5-.5.5h-.5v-4.5zm-5.7 4.5h-.5v-4.5h.5v2.3l1.9-2.3h.7l-2.2 2.6 2.3 2.5h-.8l-1.9-2.1v2.1z"/></svg></div><span>LINE</span></div>
                <div class="share-item" onclick="shareTo('copy')"><div class="share-icon-box" style="background:#555;"><svg viewBox="0 0 24 24"><path d="M16 1H4C2.9 1 2 1.9 2 3V17H4V3H16V1ZM19 5H8C6.9 5 6 5.9 6 7V21C6 22.1 6.9 23 8 23H19C20.1 23 21 22.1 21 21V7C21 5.9 20.1 5 19 5ZM19 21H8V7H19V21Z"/></svg></div><span>è¤‡è£½</span></div>
            </div>
        </div>
    </div>

    <div id="quiz-modal" class="modal-overlay">
        <div class="quiz-box">
            <div id="quiz-question" class="quiz-question"></div>
            <div class="quiz-options">
                <button class="quiz-btn" onclick="checkQuiz(1)">A</button>
                <button class="quiz-btn" onclick="checkQuiz(2)">B</button>
                <button class="quiz-btn" onclick="checkQuiz(3)">C</button>
            </div>
            <div class="close-modal" onclick="closeModal('quiz-modal', event)">æ”¾æ£„æŒ‘æˆ°</div>
        </div>
    </div>

    <script>
        const MY_LIFF_ID = "2008941841-8KQq29wn"; 
        const WEBHOOK_URL = ""; 
        const SURVEYCAKE_URL = "https://www.surveycake.com/s/æ‚¨çš„å•å·ä»£ç¢¼"; 
        const SURVEY_UID_ALIAS = "line_uid"; 
        const TASKS = ['map', 'quiz', 'wish', 'beacon', 'bus'];
        const FRAME_IMG_SRC = "./frame.png"; 

        const routesInfo = {
            "R1": { title: "ä¸€èŒ¶ä¸€ç¤¦", desc: "æ¸…ä»£åŒ…ç¨®èŒ¶èˆ‡æ—¥æ²»ç…¤ç¤¦çš„é›™è»Œæ™‚å…‰", spots: ["spot1","spot2","spot3","spot4","spot5","spot6","spot7","spot8","spot9"] },
            "R2": { title: "å±±æ—ç§˜å¢ƒ", desc: "èµ°é€²å¾Œå±±ï¼Œçœºæœ›è‡ºåŒ—ç›†åœ°çš„é¼é—Šæ™¯ç·»", spots: ["route2_spot1","route2_spot2","route2_spot3","route2_spot4","route2_spot5","route2_spot6"] },
            "R3": { title: "ç¶²ç¾æ‰“å¡", desc: "å¾å½äº¬éƒ½åˆ°å¤¢å¹»æ¹–æ™¯", spots: ["route3_spot1","route3_spot2","route3_spot3","route3_spot4","route3_spot5","route3_spot6"] },
            "R4": { title: "ç™¾å¹´ä¿¡ä»°", desc: "è§£è®€æ±æ­¢çš„å¤šå±¤ä¿¡ä»°èˆ‡æ­·å²å¢“åœ’", spots: ["route4_spot1","route4_spot2","route4_spot3","route4_spot4","route4_spot5","route4_spot6","route4_spot7"] },
            "ACT": { title: "æ´»å‹•å¿«è¨Š", desc: "æ±æ­¢ç•¶å­£ç†±é–€æ´»å‹•è³‡è¨Š" }
        };

        const spotsData = {
            // [æ´»å‹•è¨Šæ¯]
            "E01": { id: "E01", route: "ACT", title: "å¤¢æƒ³ç¤¾å€å˜‰å¹´è¯", img: "https://newtaipei.travel/content/images/attractions/26850/1024x768_attractions-image-j1o3r4gbu06342s3z9s-qa.jpg", desc: "å…¨å°æœ€ç˜‹ç‹‚çš„è—è¡“éŠè¡Œï¼Œçµåˆæ£®å·´é¼“èˆ‡å¤§å‹èŠ±è»Šï¼Œå±•ç¾æ±æ­¢çš„ç†±æƒ…èˆ‡å‰µæ„ã€‚æ¯å¹´å†¬å¤©èˆ‰è¾¦ï¼Œé‚€è«‹ä¸–ç•Œå„åœ°çš„è—è¡“å®¶å…±è¥„ç››èˆ‰ã€‚", query: "å¤¢æƒ³ç¤¾å€", hasBeacon: false },
            "E02": { id: "E02", route: "ACT", title: "åº·èª¥æºªæ«»èŠ±å­£", img: "https://newtaipei.travel/content/images/attractions/26792/1024x768_attractions-image-j1o3r4gbu06342s3z9s-qa.jpg", desc: "æ±æ­¢äººçš„è³æ«»ç§˜å¢ƒï¼Œæºªç•”å…©å´ç¨®æ»¿å±±æ«»èŠ±ï¼Œå¤œé–“é»ç‡ˆå¾Œçš„ã€Œå¤œæ«»ã€æ›´æ˜¯æµªæ¼«ã€‚èŠ±å­£æœŸé–“æ²¿å²¸æ­¥é“æ˜¯æ•£æ­¥é¦–é¸ã€‚", query: "åº·èª¥æºªæ«»èŠ±", hasBeacon: false },
            "E03": { id: "E03", route: "ACT", title: "æ±ç¢‡è·¯è¢ç«èŸ²", img: "https://tour.ntpc.gov.tw/Content/Upload/Place/6d368051-9e7f-44e8-8a4e-1b8f5745778a.jpg", desc: "æ˜¥å¤äº¤æ›¿ä¹‹éš›çš„å¤¢å¹»å°æ—…è¡Œï¼Œæ²¿è‘—æ±ç¢‡è·¯æ¼«æ­¥ï¼Œæ¬£è³è‰å¢é–“é–ƒçˆçš„ç¶ è‰²ç²¾éˆã€‚è«‹å‹™å¿…éµå®ˆè³è¢ç¦®å„€ï¼Œä¸æŠ“ã€ä¸ç…§äº®ã€‚", query: "æ±ç¢‡è·¯è¢ç«èŸ²", hasBeacon: false },

            // [R01]
            "spot1": { id: "1", route: "R1", title: "æ±æ­¢ç«è»Šç«™", img: "https://upload.wikimedia.org/wikipedia/commons/thumb/6/66/TRA_Xizhi_Station_202308.jpg/800px-TRA_Xizhi_Station_202308.jpg", desc: "æ—…ç¨‹èµ·é»ã€‚ã€Œæ±æ­¢ã€èˆŠç¨±ã€Œæ°´è¿”è…³ã€ï¼Œæ„æŒ‡åŸºéš†æ²³æ½®æ±è‡³æ­¤è€Œè¿”ã€‚", query: "æ±æ­¢ç«è»Šç«™", hasBeacon: true },
            "spot2": { id: "2", route: "R1", title: "æ¿Ÿå¾·å®®", img: "https://tour.ntpc.gov.tw/Content/Upload/Place/6d368051-9e7f-44e8-8a4e-1b8f5745778a.jpg", desc: "ä¿—ç¨±æ±æ­¢åª½ç¥–å»Ÿï¼Œæ˜¯é€šéˆå°‘å¥³çš„å–æ™¯åœ°ï¼Œè¦‹è­‰äº†è€è¡—çš„èˆˆè¡°ã€‚", query: "æ±æ­¢æ¿Ÿå¾·å®®", hasBeacon: false },
            "spot3": { id: "3", route: "R1", title: "è˜‡å®¶å¤å", img: "https://newtaipei.travel/content/images/attractions/26786/1024x768_attractions-image-j1o3r4gbu06342s3z9s-qa.jpg", desc: "ç´…ç£šæ‹±å»Šçš„ç™¾å¹´èŒ¶å•†å®…é‚¸ï¼Œè¦‹è­‰äº†æ±æ­¢èŒ¶è‘‰å¤–éŠ·çš„é»ƒé‡‘å¹´ä»£ã€‚", query: "æ±æ­¢è˜‡å®¶å¤å", hasBeacon: false },
            "spot4": { id: "4", route: "R1", title: "æ±æ­¢è€è¡—", img: "https://tour.ntpc.gov.tw/Content/Upload/Place/ed979927-567c-48c9-947b-1178c520857b.jpg", desc: "ä¸­æ­£è€è¡—ï¼Œæ¸…ä»£ã€Œå³°ä»”å³™åº„ã€å•†æ¥­è¡—éºè·¡ã€‚", query: "æ±æ­¢ä¸­æ­£è€è¡—", hasBeacon: false },
            "spot5": { id: "5", route: "R1", title: "å»ºé †èŒ¶è¡Œ", img: "https://newtaipei.travel/content/images/attractions/41830/1024x768_attractions-image-1.jpg", desc: "å‰µç«‹æ–¼1885å¹´ï¼Œæ±æ­¢ç¾å­˜æœ€å¤è€çš„èŒ¶è¡Œã€‚", query: "æ±æ­¢å»ºé †èŒ¶è¡Œ", hasBeacon: true },
            "spot6": { id: "6", route: "R1", title: "èŒ„è‹³è…³éµè·¯éºè·¡", img: "https://tour.ntpc.gov.tw/Content/Upload/Place/6d368051-9e7f-44e8-8a4e-1b8f5745778a.jpg", desc: "ä½æ–¼é«˜æ¶éµè·¯æ©‹ä¸‹ï¼Œä¿ç•™è‘—æ¸…é ˜æ™‚æœŸè‡³æ—¥æ²»æ™‚æœŸçš„éµè·¯åŸºåº§ã€‚", query: "æ±æ­¢èŒ„è‹³è…³éµè·¯éºè·¡", hasBeacon: false },
            "spot7": { id: "7", route: "R1", title: "æ˜Ÿå…‰æ©‹", img: "https://newtaipei.travel/content/images/attractions/26815/1024x768_attractions-image-w4q9s3h5g06342s3z9s-qa.jpg", desc: "æ©«è·¨åŸºéš†æ²³çš„å–®æ–œå¡”æ™¯è§€æ©‹ï¼Œé€ å‹å¦‚ä¸€æ”¯å·¨å¤§çš„éº¥å…‹é¢¨ã€‚", query: "æ±æ­¢æ˜Ÿå…‰æ©‹", hasBeacon: true },
            "spot8": { id: "8", route: "R1", title: "æ±å±±ç…¤ç¤¦éºè·¡", img: "https://newtaipei.travel/content/images/attractions/26815/1024x768_attractions-image-w4q9s3h5g06342s3z9s-qa.jpg", desc: "æ±æ­¢æ›¾æ˜¯åŒ—å°ç£é‡è¦ç…¤ç¤¦ç”¢åœ°ã€‚", query: "æ±æ­¢æ±å±±ç…¤ç¤¦", hasBeacon: false },
            "spot9": { id: "9", route: "R1", title: "äº”å µéµè·¯éš§é“", img: "https://newtaipei.travel/content/images/attractions/26786/1024x768_attractions-image-j1o3r4gbu06342s3z9s-qa.jpg", desc: "ç©¿è¶Šæ™‚ç©ºçš„ç´…ç£šéš§é“ï¼ŒåŸç‚ºæ—¥æ²»æ™‚æœŸèˆŠéš§é“ã€‚", query: "äº”å µå°éµèˆŠéš§é“", hasBeacon: false },
            
            // [R02]
            "route2_spot1": { id: "1", route: "R2", title: "æ±æ­¢ç«è»Šç«™", img: "https://upload.wikimedia.org/wikipedia/commons/thumb/6/66/TRA_Xizhi_Station_202308.jpg/800px-TRA_Xizhi_Station_202308.jpg", desc: "äº¤é€šèµ·é»ï¼Œè£œçµ¦å……è¶³ã€‚", query: "æ±æ­¢ç«è»Šç«™", hasBeacon: true },
            "route2_spot2": { id: "2", route: "R2", title: "è–å¾·å®®", img: "https://newtaipei.travel/content/images/attractions/26765/1024x768_attractions-image-w4q9s3h5g06342s3z9s-qa.jpg", desc: "ä»¥è¯éº—çš„å®®å»Ÿå»ºç¯‰è‘—ç¨±ï¼Œåœ°ç†ä½ç½®ä½³ã€‚", query: "æ±æ­¢è–å¾·å®®", hasBeacon: false },
            "route2_spot3": { id: "3", route: "R2", title: "å¤§å°–å±±å¤©ç§€å®®", img: "https://tour.ntpc.gov.tw/Content/Upload/Place/19f18703-99d9-43c2-8419-48283526188e.jpg", desc: "ç™»å±±å®¢çš„é‡è¦ä¼‘æ†©é»ï¼Œå»Ÿå‰å»£å ´è¦–é‡æ¥µä½³ã€‚", query: "æ±æ­¢å¤©ç§€å®®", hasBeacon: true },
            "route2_spot4": { id: "4", route: "R2", title: "å¤§å°–å±±ç™»å±±æ­¥é“", img: "https://tour.ntpc.gov.tw/Content/Upload/Place/d8958288-7718-4067-8526-70e281512781.jpg", desc: "çŸ³éšé‹ªè¨­å®Œå–„ï¼Œæ²¿é€”æ—è”­èŒ‚å¯†ã€‚", query: "å¤§å°–å±±ç™»å±±æ­¥é“", hasBeacon: false },
            "route2_spot5": { id: "5", route: "R2", title: "ç§€å³°ç€‘å¸ƒ", img: "https://tour.ntpc.gov.tw/Content/Upload/Place/ed979927-567c-48c9-947b-1178c520857b.jpg", desc: "å³­å£æ‡¸å´–é–“çš„éŠ€ç™½çµ²å¸¶ï¼Œæ¯æ°´æœŸæ¶“æ¶“ç´°æµã€‚", query: "æ±æ­¢ç§€å³°ç€‘å¸ƒ", hasBeacon: true },
            "route2_spot6": { id: "6", route: "R2", title: "å››åˆ†å°¾å±±", img: "https://newtaipei.travel/content/images/attractions/26792/1024x768_attractions-image-j1o3r4gbu06342s3z9s-qa.jpg", desc: "æ“æœ‰å…©é¡†ä¸‰è§’é»ï¼Œå±•æœ›æ¥µä½³ã€‚", query: "æ±æ­¢å››åˆ†å°¾å±±", hasBeacon: false },

            // [R03]
            "route3_spot1": { id: "1", route: "R3", title: "æ±ç§‘ç«è»Šç«™åŒ—ç«™", img: "https://upload.wikimedia.org/wikipedia/commons/thumb/c/cd/Xike_Station_North_Exit_20170513.jpg/800px-Xike_Station_North_Exit_20170513.jpg", desc: "å…·æœ‰ç¾ä»£æ„Ÿçš„è»Šç«™çµæ§‹ã€‚", query: "æ±ç§‘ç«è»Šç«™", hasBeacon: false },
            "route3_spot2": { id: "2", route: "R3", title: "æ‹±åŒ—æ®¿", img: "https://newtaipei.travel/content/images/attractions/26801/1024x768_attractions-image-j1o3r4gbu06342s3z9s-qa.jpg", desc: "è‘—åçš„è³æ¥“å‹åœ°ï¼Œå……æ»¿æ—¥å¼æ°›åœã€‚", query: "æ±æ­¢æ‹±åŒ—æ®¿", hasBeacon: true },
            "route3_spot3": { id: "3", route: "R3", title: "æ–°å±±å¤¢æ¹–", img: "https://newtaipei.travel/content/images/attractions/26780/1024x768_attractions-image-j1o3r4gbu06342s3z9s-qa.jpg", desc: "ç¢§ç¶ æ¹–æ°´å€’æ˜ å±±å½±ï¼Œå¤¢å¹»è¿·æ¿›ã€‚", query: "æ–°å±±å¤¢æ¹–", hasBeacon: true },
            "route3_spot4": { id: "4", route: "R3", title: "å¤§é‡‘å‰›å²©", img: "https://tour.ntpc.gov.tw/Content/Upload/Place/6d368051-9e7f-44e8-8a4e-1b8f5745778a.jpg", desc: "éš±èº«å±±æ—çš„å¥‡å²©æ€ªçŸ³ï¼Œå½¢ä¼¼é‡‘å‰›è‡‰è­œã€‚", query: "æ–°å±±å¤§é‡‘å‰›å²©", hasBeacon: false },
            "route3_spot5": { id: "5", route: "R3", title: "ç§€å³°ç€‘å¸ƒ", img: "https://tour.ntpc.gov.tw/Content/Upload/Place/ed979927-567c-48c9-947b-1178c520857b.jpg", desc: "çµåˆå±±æ—èˆ‡æ°´æ™¯ï¼Œåˆ©ç”¨é•·æ™‚é–“æ›å…‰å¯æ‹å‡ºå¤¢å¹»æµæ°´ã€‚", query: "æ±æ­¢ç§€å³°ç€‘å¸ƒ", hasBeacon: false },
            "route3_spot6": { id: "6", route: "R3", title: "æ–°å±±", img: "https://newtaipei.travel/content/images/attractions/26780/1024x768_attractions-image-j1o3r4gbu06342s3z9s-qa.jpg", desc: "å·¨çŸ³å¶™å³‹çš„å±±é ‚ï¼Œæ“æœ‰çµ•ä½³çš„æ‡¸å´–è¦–è§’ã€‚", query: "æ±æ­¢æ–°å±±", hasBeacon: false },

            // [R04]
            "route4_spot1": { id: "1", route: "R4", title: "æ±æ­¢ç«è»Šç«™", img: "https://upload.wikimedia.org/wikipedia/commons/thumb/6/66/TRA_Xizhi_Station_202308.jpg/800px-TRA_Xizhi_Station_202308.jpg", desc: "ä¿¡ä»°ä¹‹æ—…çš„èµ·é»ã€‚", query: "æ±æ­¢ç«è»Šç«™", hasBeacon: true },
            "route4_spot2": { id: "2", route: "R4", title: "ç§€å³°å±±éœä¿®ç¦ªé™¢", img: "https://tour.ntpc.gov.tw/Content/Upload/Place/6d368051-9e7f-44e8-8a4e-1b8f5745778a.jpg", desc: "å¹½éœçš„ä½›é–€è–åœ°ï¼Œç’°å¢ƒæ¸…å¹½ã€‚", query: "æ±æ­¢éœä¿®ç¦ªé™¢", hasBeacon: false },
            "route4_spot3": { id: "3", route: "R4", title: "æœæœˆç¬™å¢“åœ’", img: "https://upload.wikimedia.org/wikipedia/commons/thumb/c/c5/Tomb_of_Du_Yuesheng.jpg/800px-Tomb_of_Du_Yuesheng.jpg", desc: "ä¸Šæµ·ç˜å‚³å¥‡äººç‰©é•·çœ æ–¼æ­¤ã€‚", query: "æœæœˆç¬™å¢“åœ’", hasBeacon: true },
            "route4_spot4": { id: "4", route: "R4", title: "ç§€å³°å±±å½Œå‹’å…§é™¢", img: "https://tour.ntpc.gov.tw/Content/Upload/Place/6d368051-9e7f-44e8-8a4e-1b8f5745778a.jpg", desc: "å¯¬æˆè€å’Œå°šå‰µå»ºï¼Œä¾›å¥‰å½Œå‹’è©è–©ã€‚", query: "æ±æ­¢å½Œå‹’å…§é™¢", hasBeacon: false },
            "route4_spot5": { id: "5", route: "R4", title: "ç§€å³°å±±æ…ˆèˆªç´€å¿µé¤¨", img: "https://tour.ntpc.gov.tw/Content/Upload/Place/6d368051-9e7f-44e8-8a4e-1b8f5745778a.jpg", desc: "ç´€å¿µå°ç£é¦–ä½è‚‰èº«è©è–©æ…ˆèˆªæ³•å¸«ã€‚", query: "ç§€å³°å±±æ…ˆèˆªç´€å¿µé¤¨", hasBeacon: false },
            "route4_spot6": { id: "6", route: "R4", title: "å¿ é †å»Ÿ", img: "https://tour.ntpc.gov.tw/Content/Upload/Place/6d368051-9e7f-44e8-8a4e-1b8f5745778a.jpg", desc: "å‰èº«ç‚ºæ±æ­¢ç¥ç¤¾ï¼Œä¿ç•™é³¥å±…èˆ‡çŸ³ç‡ˆç± ã€‚", query: "æ±æ­¢å¿ é †å»Ÿ", hasBeacon: true },
            "route4_spot7": { id: "7", route: "R4", title: "æ¿Ÿå¾·å®®", img: "https://tour.ntpc.gov.tw/Content/Upload/Place/6d368051-9e7f-44e8-8a4e-1b8f5745778a.jpg", desc: "ä¿—ç¨±æ±æ­¢åª½ç¥–å»Ÿï¼Œæ­·å²æ‚ ä¹…ã€‚", query: "æ±æ­¢æ¿Ÿå¾·å®®", hasBeacon: false }
        };

        let pendingTask = null; 
        let leaveTime = 0; 
        let currentSpotData = null;

        window.onload = function() {
            liff.init({ liffId: MY_LIFF_ID }).then(() => {
                if (!liff.isLoggedIn()) {
                    liff.login();
                } else {
                    updateSurveyLink(); 
                    renderContent();
                }
            }).catch(err => { 
                console.error("LIFF init error:", err); 
                renderContent(); 
            });
        };

        function updateSurveyLink() {
            let userId = "";
            try { if (liff.isLoggedIn()) userId = liff.getContext().userId; } catch (e) {}
            if (userId) {
                const finalUrl = `${SURVEYCAKE_URL}?${SURVEY_UID_ALIAS}=${userId}`;
                const btn = document.querySelector('.survey-btn');
                if (btn) btn.href = finalUrl;
            }
        }

        function renderContent() {
            try {
                var urlParams = new URLSearchParams(window.location.search);
                var spotKey = urlParams.get('id') || 'spot1';

                // äº¤é€šè½‰å€
                if (spotKey === 'TRANS_BUS') { window.location.replace("https://ebus.gov.taipei/"); return; }
                if (spotKey === 'TRANS_TRAIN') { window.location.replace("https://tip.railway.gov.tw/tra-tip-web/tip"); return; }
                if (spotKey === 'TRANS_BIKE') { window.location.replace("https://www.youbike.com.tw/region/ntpc/"); return; }

                // --- æ´»å‹•æ¨¡å¼åµæ¸¬ ---
                // åªè¦æ˜¯ 'E' é–‹é ­ï¼Œæˆ–æ˜¯ route ç‚º 'ACT'ï¼Œå°±å¥—ç”¨æ´»å‹•æ¨¡å¼
                var isActivity = spotKey.startsWith('E') || (spotsData[spotKey] && spotsData[spotKey].route === 'ACT');
                if (isActivity) {
                    document.body.classList.add('activity-mode');
                } else {
                    document.body.classList.remove('activity-mode');
                }

                var data = spotsData[spotKey];
                if (!data) { data = spotsData['spot1']; spotKey = 'spot1'; } // Fallback
                currentSpotData = data;

                // æ¸²æŸ“
                if(document.getElementById('spot-title')) document.getElementById('spot-title').innerText = data.title;
                if(document.getElementById('spot-desc')) document.getElementById('spot-desc').innerText = data.desc;
                if(document.getElementById('spot-img')) document.getElementById('spot-img').src = data.img;

                var routeKey = data.route || "R1"; 
                var rInfo = routesInfo[routeKey];
                if(rInfo) {
                    if(document.getElementById('route-tag')) document.getElementById('route-tag').innerText = rInfo.title.split('ï¼š')[0]; 
                    if(document.getElementById('route-desc')) document.getElementById('route-desc').innerText = rInfo.desc;
                    
                    // åªåœ¨éæ´»å‹•æ¨¡å¼ä¸‹é¡¯ç¤ºç«™é»ç·¨è™Ÿ
                    if(!isActivity) {
                        var idx = rInfo.spots ? rInfo.spots.indexOf(spotKey) : -1;
                        if(idx !== -1 && document.getElementById('spot-number')) {
                            document.getElementById('spot-number').innerText = "æœ¬è·¯ç·šç¬¬ " + (idx + 1) + " ç«™ï¼Œå…± " + rInfo.spots.length + " ç«™";
                        }
                    }
                }

                var mapQuery = encodeURIComponent(data.query);
                if(document.getElementById('map-btn')) document.getElementById('map-btn').href = "https://www.google.com/maps/search/?api=1&query=$" + mapQuery;
                if(document.getElementById('food-btn')) document.getElementById('food-btn').href = "https://www.google.com/maps/search/?api=1&query=$" + mapQuery + "+ç¾é£Ÿ";
                if(document.getElementById('parking-btn')) document.getElementById('parking-btn').href = "https://www.google.com/maps/search/?api=1&query=$" + mapQuery + "+åœè»Šå ´";

                // ä¸‹ä¸€ç«™é‚è¼¯ (éæ´»å‹•æ¨¡å¼æ‰éœ€è¦)
                if(!isActivity && rInfo && rInfo.spots) {
                    var currentIdx = rInfo.spots.indexOf(spotKey);
                    var nextIdx = (currentIdx + 1) % rInfo.spots.length;
                    var nextSpotKey = rInfo.spots[nextIdx];
                    var nextData = spotsData[nextSpotKey];
                    var busBtn = document.getElementById('bus-btn');
                    if (nextData && busBtn) {
                        busBtn.href = "https://www.google.com/maps/dir/?api=1&origin=$" + encodeURIComponent(data.query) + "&destination=" + encodeURIComponent(nextData.query) + "&travelmode=transit";
                        var label = busBtn.querySelector('.bus-label');
                        if(label) label.innerText = 'å»' + nextData.title;
                    }
                }

                if (data.hasBeacon && !isActivity) initBeaconSimulation();

                initTaskProgress();
            } catch (e) {
                console.error("Render Error:", e);
            } finally {
                var loader = document.getElementById('loading');
                if(loader) loader.style.display = 'none';
                var main = document.getElementById('main-content');
                if(main) main.style.display = 'block';
            }
        }

        // å…¶é¤˜åŠŸèƒ½ç¶­æŒä¸è®Š
        function collectAction(taskName) {
            var collected = JSON.parse(localStorage.getItem('xizhi_action_stamps')) || [];
            if (collected.indexOf(taskName) === -1) {
                collected.push(taskName);
                localStorage.setItem('xizhi_action_stamps', JSON.stringify(collected));
                trackAction('collect_' + taskName);
                setTimeout(initTaskProgress, 500); 
            }
        }
        function handleClickWithTrack(taskName) { collectAction(taskName); pendingTask = taskName; leaveTime = Date.now(); trackAction('click_' + taskName); }
        function isTaskDone(taskName) { let collected = JSON.parse(localStorage.getItem('xizhi_action_stamps')) || []; return collected.includes(taskName); }
        function initTaskProgress() {
            let collected = JSON.parse(localStorage.getItem('xizhi_action_stamps')) || [];
            TASKS.forEach(task => {
                const el = document.getElementById('stamp-' + task);
                if(el) {
                    if (collected.includes(task)) {
                        el.classList.add('active');
                        el.innerText = 'âœ“'; 
                    } else {
                        el.classList.remove('active');
                    }
                }
            });
            const wishBtn = document.getElementById('wish-btn');
            if(wishBtn) {
                if(collected.includes('wish')) { wishBtn.classList.add('active'); wishBtn.innerHTML = 'â¤ï¸'; } else { wishBtn.classList.remove('active'); wishBtn.innerHTML = 'â™¡'; }
            }
            const progText = document.getElementById('progress-text');
            const progBar = document.getElementById('progress-bar');
            if(progText) progText.innerText = `${collected.length}/5`;
            if(progBar) progBar.style.width = `${(collected.length/5)*100}%`;
            
            if (collected.length >= 5) { 
                const survey = document.getElementById('survey-box');
                const memorial = document.getElementById('memorial-box');
                if(survey) survey.style.display = 'block'; 
                if(memorial) memorial.style.display = 'block'; 
            }
        }
        function handleImageUpload(e) {
            var file = e.target.files[0];
            if(!file) return;
            var reader = new FileReader();
            reader.onload = function(event) { 
                var img = new Image(); 
                img.onload = function() { drawCanvas(img); }; 
                img.src = event.target.result; 
            };
            reader.readAsDataURL(file);
        }
        function drawCanvas(userImg) {
            var canvas = document.getElementById('result-canvas');
            if(!canvas) return;
            var ctx = canvas.getContext('2d');
            var size = 800; canvas.width = size; canvas.height = size;
            var scale = Math.max(size / userImg.width, size / userImg.height);
            var x = (size / 2) - (userImg.width / 2) * scale;
            var y = (size / 2) - (userImg.height / 2) * scale;
            ctx.drawImage(userImg, x, y, userImg.width * scale, userImg.height * scale);
            var frameImg = new Image();
            frameImg.onload = function() {
                ctx.drawImage(frameImg, 0, 0, size, size);
                var finalImg = document.getElementById('final-img');
                if(finalImg) {
                    finalImg.src = canvas.toDataURL("image/jpeg", 0.8);
                    finalImg.style.display = "block";
                    var dlMsg = document.getElementById('download-msg');
                    if(dlMsg) dlMsg.style.display = "block";
                    finalImg.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            };
            frameImg.src = FRAME_IMG_SRC;
        }
        function openShareModal() { var el = document.getElementById('share-modal'); if(el) el.style.display = 'flex'; }
        function closeModal(modalId, e) { if (e.target.id === modalId || e.target.classList.contains('close-modal')) { document.getElementById(modalId).style.display = 'none'; } }
        function shareTo(platform) { document.getElementById('share-modal').style.display = 'none'; }
        function toggleDesc() {
            var container = document.getElementById('spot-desc-container');
            var btn = document.getElementById('read-more-btn');
            if(container && btn) {
                container.classList.toggle('expanded');
                if (container.classList.contains('expanded')) { btn.innerText = "â–² æ”¶èµ·ç°¡ä»‹"; } else { btn.innerText = "â–¼ äº†è§£æ›´å¤šæ•…äº‹"; }
            }
        }
        function resetProgress() { if(confirm("é‡ç½®ï¼Ÿ")) { localStorage.removeItem('xizhi_action_stamps'); location.reload(); } }
        function trackAction(actionName) { sendToWebhook(actionName, 0); }
        function trackDuration(taskName, seconds) { sendToWebhook("stay_on_" + taskName, seconds); }
        function sendToWebhook(action, durationVal) {
            if (!WEBHOOK_URL) return;
            var userId = "unknown";
            try { if (liff.isLoggedIn()) userId = liff.getContext().userId; } catch(e) {}
            var spotId = new URLSearchParams(window.location.search).get('id') || 'spot1';
            fetch(WEBHOOK_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ userId: userId, action: action, spot: spotId, duration: durationVal, timestamp: new Date().toISOString() }) }).catch(function(err) { console.error(err); });
        }
    </script>
</body>
</html>
