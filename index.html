<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ±æ­¢æ·±åº¦å°è¦½</title>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        /* --- åŸºç¤è¨­å®š --- */
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; padding: 0; background-color: #f4f7f6; color: #333; padding-bottom: 80px; /* ç•™çµ¦åº•éƒ¨å°èˆªç©ºé–“ */ }
        
        /* --- é ‚éƒ¨é€²åº¦æ¢ --- */
        .progress-container { position: fixed; top: 0; left: 0; width: 100%; height: 6px; background: #e0e0e0; z-index: 2000; }
        .progress-bar { height: 100%; background: linear-gradient(90deg, #ff8a00, #e52e71); width: 0%; transition: width 0.5s ease; border-radius: 0 3px 3px 0; }

        /* --- Hero åœ–ç‰‡å€ --- */
        .hero-container { position: relative; width: 100%; height: 35vh; overflow: hidden; }
        .hero-img { width: 100%; height: 100%; object-fit: cover; }
        
        /* --- ä¸»è¦å…§å®¹å¡ç‰‡ --- */
        .content-card { position: relative; background: white; border-radius: 24px 24px 0 0; margin-top: -25px; padding: 25px; box-shadow: 0 -5px 20px rgba(0,0,0,0.05); min-height: 60vh; }
        
        /* --- æ¨™é¡Œèˆ‡æ¨™ç±¤ --- */
        h1 { margin: 0 0 5px 0; font-size: 24px; font-weight: 800; color: #2c3e50; }
        .sub-tag { display: inline-block; font-size: 12px; color: #888; background: #eee; padding: 3px 8px; border-radius: 4px; margin-bottom: 15px; }

        /* --- æ‘ºç–Šç°¡ä»‹ --- */
        .desc-box { margin-bottom: 25px; }
        .desc-text { font-size: 15px; line-height: 1.6; color: #555; max-height: 80px; overflow: hidden; transition: max-height 0.4s ease; position: relative; }
        .desc-text.expanded { max-height: 1000px; } /* å±•é–‹å¾Œçš„é«˜åº¦ */
        /* æ¼¸å±¤é®ç½© (æœªå±•é–‹æ™‚é¡¯ç¤º) */
        .desc-mask { position: absolute; bottom: 0; left: 0; width: 100%; height: 40px; background: linear-gradient(to bottom, transparent, white); pointer-events: none; transition: opacity 0.3s; }
        .desc-text.expanded .desc-mask { opacity: 0; }
        
        .read-more-btn { display: block; width: 100%; text-align: center; padding-top: 5px; color: #007bff; font-weight: bold; font-size: 13px; cursor: pointer; }

        /* --- äº¤é€šå·¥å…·ç®± (ä¸­å±¤å·¥å…·) --- */
        .transport-grid { display: flex; gap: 10px; margin-bottom: 30px; }
        .t-btn { flex: 1; display: flex; align-items: center; justify-content: center; gap: 6px; padding: 12px; border-radius: 12px; text-decoration: none; color: white; font-weight: bold; font-size: 14px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); transition: transform 0.1s; }
        .t-btn:active { transform: scale(0.96); }
        .bg-ubike { background: linear-gradient(135deg, #fce38a 0%, #f38181 100%); color: #555; } /* äº®é»ƒæš–è‰² */
        .bg-uber { background: #2c3e50; } /* é»‘è‰² */

        /* --- äº’å‹•é›†ç« å€ (éŠæˆ²å±¤) --- */
        .game-section { background: #fff8e1; border: 2px dashed #ffc107; border-radius: 16px; padding: 20px; text-align: center; margin-bottom: 20px; }
        .game-title { font-weight: bold; color: #d35400; margin-bottom: 10px; font-size: 16px; display: flex; align-items: center; justify-content: center; gap: 5px; }
        .stamp-container { display: flex; justify-content: center; gap: 8px; margin-bottom: 15px; flex-wrap: wrap; }
        .stamp { width: 30px; height: 30px; border-radius: 50%; background: #e0e0e0; color: white; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold; }
        .stamp.active { background: #ff512f; box-shadow: 0 2px 8px rgba(255, 81, 47, 0.4); transform: scale(1.1); }
        
        .checkin-btn { width: 100%; padding: 14px; background: #27ae60; color: white; border: none; border-radius: 12px; font-size: 16px; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; box-shadow: 0 4px 10px rgba(39, 174, 96, 0.3); }
        .checkin-btn:disabled { background: #ccc; cursor: not-allowed; box-shadow: none; }

        /* --- å•å·å€å¡Š (éš±è—çå‹µ) --- */
        #survey-box { display: none; margin-top: 20px; animation: popUp 0.5s ease; }
        .survey-btn { display: block; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; text-align: center; padding: 16px; border-radius: 12px; text-decoration: none; font-weight: bold; box-shadow: 0 4px 15px rgba(118, 75, 162, 0.4); }
        @keyframes popUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* --- åº•éƒ¨å›ºå®šå°èˆª (Action Bar) --- */
        .sticky-footer { position: fixed; bottom: 0; left: 0; width: 100%; background: white; padding: 10px 15px; box-sizing: border-box; display: flex; gap: 10px; box-shadow: 0 -4px 20px rgba(0,0,0,0.08); z-index: 1000; padding-bottom: max(10px, env(safe-area-inset-bottom)); }
        .footer-btn { flex: 1; padding: 12px; border-radius: 10px; text-align: center; text-decoration: none; font-weight: bold; font-size: 15px; display: flex; align-items: center; justify-content: center; gap: 6px; }
        .btn-map { background: #f1f3f5; color: #495057; }
        .btn-food { background: #ff6b6b; color: white; }

        /* --- è¼‰å…¥ç•«é¢ --- */
        #loading { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; display: flex; align-items: center; justify-content: center; z-index: 3000; flex-direction: column; color: #888; }
    </style>
</head>
<body>

    <div id="loading">
        <div style="font-size: 24px; margin-bottom: 10px;">â³</div>
        <div>è¼‰å…¥æ™¯é»è³‡æ–™ä¸­...</div>
    </div>

    <div class="progress-container">
        <div id="progress-bar" class="progress-bar"></div>
    </div>

    <div id="main-content" style="display: none;">
        
        <div class="hero-container">
            <img id="spot-img" class="hero-img" src="" alt="æ™¯é»åœ–ç‰‡">
        </div>

        <div class="content-card">
            <span class="sub-tag">æ±æ­¢æ·±åº¦å°è¦½ NO.<span id="spot-index">1</span></span>
            <h1 id="spot-title"></h1>

            <div class="desc-box">
                <div id="spot-desc-container" class="desc-text">
                    <span id="spot-desc"></span>
                    <div class="desc-mask"></div>
                </div>
                <div id="read-more-btn" class="read-more-btn" onclick="toggleDesc()">â–¼ äº†è§£æ›´å¤šæ•…äº‹</div>
            </div>

            <div class="transport-grid">
                <a href="https://www.google.com/maps/search/?api=1&query=..." target="_blank" class="t-btn bg-ubike" onclick="trackAction('click_ubike')">
                    ğŸš² æ‰¾ YouBike
                </a>
                <a href="https://m.uber.com/ul" target="_blank" class="t-btn bg-uber" onclick="trackAction('click_uber')">
                    ğŸš• å« Uber
                </a>
            </div>

            <div class="game-section">
                <div class="game-title">ğŸ† æ¢éšªå®¶é›†ç«  (é€²åº¦: <span id="progress-text">0/8</span>)</div>
                <div id="stamp-container" class="stamp-container">
                    </div>
                
                <button id="checkin-btn" class="checkin-btn" onclick="doCheckIn()">
                    ğŸ“ æŠµé”æ‰“å¡ (+1)
                </button>
            </div>

            <div id="survey-box">
                <a href="https://forms.gle/æ‚¨çš„å•å·é€£çµåœ¨é€™è£¡" target="_blank" class="survey-btn" onclick="trackAction('click_survey')">
                    ğŸ“ é ˜å–å®Œè³½è­‰æ›¸ (å¡«å¯«å¾Œæ¸¬å•å·)
                </a>
                <p style="text-align: center; color: #888; font-size: 12px; margin-top: 8px;">å¡«å¯«å®Œç•¢å¯ç²å¾—æ±æ­¢ç¾é£Ÿå„ªæƒ åˆ¸</p>
            </div>

        </div>
    </div>

    <div class="sticky-footer">
        <a id="map-btn" href="#" class="footer-btn btn-map" target="_blank" onclick="trackAction('click_map')">
            ğŸ“ å¸¶æˆ‘å»
        </a>
        <a id="food-btn" href="#" class="footer-btn btn-food" target="_blank" onclick="trackAction('click_food')">
            ğŸ´ é™„è¿‘ç¾é£Ÿ
        </a>
    </div>

    <script>
        // ==========================================
        // ğŸ› ï¸ è¨­å®šå€ (è«‹ä¿®æ”¹é€™è£¡)
        // ==========================================
        const MY_LIFF_ID = "2008941841-8KQq29wn"; // æ‚¨çš„ LIFF ID
        const WEBHOOK_URL = ""; // ã€é‡è¦ã€‘è«‹å¡«å…¥ Make çš„ Webhook ç¶²å€ï¼Œè‹¥é‚„æ²’åšå¯å…ˆç•™ç©º

        // ==========================================
        // ğŸ“¦ è³‡æ–™åº« (8 å€‹æ™¯é»)
        // ==========================================
        const spotsData = {
            "spot1": { id: 1, title: "æ±æ­¢ç«è»Šç«™", img: "./spot1.jpg", desc: "æ±æ­¢çš„äº¤é€šå¿ƒè‡Ÿï¼Œä¹Ÿæ˜¯ç¾é£Ÿçš„ä¸€ç´šæˆ°å€ã€‚ç«™å‰å»£å ´ç¶“å¸¸èˆ‰è¾¦æ´»å‹•ï¼Œå‘¨é‚Šå··å¼„éš±è—è‘—è¨±å¤šåœ¨åœ°äººæ¨è–¦çš„å¤æ—©å‘³å°åƒã€‚é€™è£¡æ˜¯æ—…ç¨‹çš„èµ·é»ï¼Œå»ºè­°å…ˆåœ¨æ­¤è£œçµ¦æ°´åˆ†èˆ‡ç³§é£Ÿã€‚", query: "æ±æ­¢ç«è»Šç«™" },
            "spot2": { id: 2, title: "ä¸­æ­£è€è¡—", img: "./spot2.jpg", desc: "èˆŠç¨±ã€Œæ°´è¿”è…³è¡—ã€ï¼Œé€™è£¡æ˜¯æ±æ­¢æœ€æ—©çš„ç™¼æºåœ°ã€‚é›–ç„¶å•†æ¥­æ°£æ¯å·²æ·¡ï¼Œä½†èµ°åœ¨ç‹¹çª„çš„è¡—é“ä¸Šï¼Œä»èƒ½çœ‹è¦‹å¹¾æ£Ÿä¿ç•™å®Œæ•´çš„ç´…ç£šå¤åèˆ‡å‚³çµ±å¸‚å ´çš„ç†±é¬§å–§å›‚ï¼Œå½·å½¿ç©¿è¶Šå›ç™¾å¹´å‰ã€‚", query: "æ±æ­¢ä¸­æ­£è€è¡—" },
            "spot3": { id: 3, title: "è˜‡å®¶å¤å", img: "./spot3.jpg", desc: "éš±èº«æ–¼ç¾ä»£å»ºç¯‰ä¹‹ä¸­ï¼Œé€™åº§æ“æœ‰ç™¾å¹´æ­·å²çš„ç´…ç£šæ‹±å»Šå»ºç¯‰ï¼Œå±•ç¤ºäº†å„ªé›…çš„å·´æ´›å…‹å¼é¢¨æ ¼ã€‚å®ƒæ˜¯æ±æ­¢æœ›æ—è˜‡å®¶çš„å®…é‚¸ï¼Œè¦‹è­‰äº†ç•¶åœ°çš„èˆˆè¡°ï¼Œç´…ç£šç‰†ä¸Šçš„é›•èŠ±ä¾ç„¶æ¸…æ™°å¯è¦‹ã€‚", query: "æ±æ­¢è˜‡å®¶å¤å" },
            "spot4": { id: 4, title: "å»ºé †èŒ¶è¡Œ", img: "./spot4.jpg", desc: "æ±æ­¢æ›¾æ˜¯åŒ—å°ç£é‡è¦çš„èŒ¶è‘‰é›†æ•£åœ°ã€‚å»ºé †èŒ¶è¡Œå‚³æ‰¿ç™¾å¹´ï¼Œåº—å…§è‡³ä»Šä»ä¿ç•™è‘—å‚³çµ±çš„è£½èŒ¶å·¥å…·èˆ‡æªœæœ¨èŒ¶ç®±ï¼Œä¸€èµ°é€²å»å°±èƒ½èåˆ°æ¿ƒéƒçš„èŒ¶é¦™ï¼Œè€é—†ä¹Ÿå¸¸ç†±æƒ…è§£èªªèŒ¶è‘‰çŸ¥è­˜ã€‚", query: "æ±æ­¢å»ºé †èŒ¶è¡Œ" },
            "spot5": { id: 5, title: "èŒ„è‹³è…³éµè·¯éºè·¡", img: "./spot5.jpg", desc: "ä½æ–¼é«˜æ¶éµè·¯ä¸‹æ–¹ï¼Œé€™è£¡ä¿ç•™äº†æ¸…æœè‡³æ—¥æ²»æ™‚æœŸçš„éµè·¯åŸºåº§éºè·¡ã€‚çœ‹è‘—æ–‘é§çš„çŸ³å¡Šï¼Œå½·å½¿èƒ½è½è¦‹ç™¾å¹´å‰ç«è»Šè½Ÿéš†é§›éçš„è²éŸ³ï¼Œæ˜¯éµé“è¿·ä¸å¯éŒ¯éçš„éš±è—æ™¯é»ã€‚", query: "æ±æ­¢èŒ„è‹³è…³éµè·¯éºè¹Ÿ" },
            "spot6": { id: 6, title: "äº”å µéš§é“", img: "./spot6.jpg", desc: "é€™æ˜¯ä¸€åº§ç©¿è¶Šæ™‚ç©ºçš„éš§é“ã€‚åŸæœ¬æ˜¯èˆŠç«è»Šéš§é“ï¼Œè’å»¢å¤šå¹´å¾Œæ”¹å»ºç‚ºè‡ªè¡Œè»Šé“ã€‚ä¿ç•™äº†ç‡»é»‘çš„ç´…ç£šç‰†èˆ‡å¾©å¤ç‡ˆå…‰ï¼Œé¨è¡Œå…¶ä¸­åˆ¥æœ‰ä¸€ç•ªé¢¨å‘³ï¼Œå½·å½¿é€²å…¥äº†ç¥éš±å°‘å¥³çš„å ´æ™¯ã€‚", query: "äº”å µå°éµèˆŠéš§é“" },
            "spot7": { id: 7, title: "æ˜Ÿå…‰æ©‹", img: "./spot7.jpg", desc: "æ©«è·¨åŸºéš†æ²³çš„å–®æ–œå¡”æ™¯è§€æ©‹ï¼Œé€ å‹åƒä¸€æ”¯å·¨å¤§çš„éº¥å…‹é¢¨ã€‚ç™½å¤©è¦–é‡é–‹é—Šï¼Œå¯ä»¥é çœºç¾¤å±±ï¼Œå¤œæ™šé»ç‡ˆå¾Œå…‰å½±è®Šå¹»ï¼Œæ˜¯æ”å½±æ„›å¥½è€…èˆ‡æƒ…ä¾¶æ•£æ­¥çš„ç†±é–€æ™¯é»ã€‚", query: "æ±æ­¢æ˜Ÿå…‰æ©‹" },
            "spot8": { id: 8, title: "æ˜Ÿåº§å…¬åœ’", img: "./spot8.jpg", desc: "ä»¥12æ˜Ÿåº§ç‚ºä¸»é¡Œçš„å¤§å‹æ²³æ¿±å…¬åœ’ï¼Œè¨­æœ‰æ²™å‘ã€éŠæ¨‚è¨­æ–½èˆ‡å»£å¤§çš„è‰çš®ã€‚é€™è£¡æ˜¯è¦ªå­åŒæ¨‚çš„å¤©å ‚ï¼Œä¹Ÿæ˜¯é€™è¶Ÿæ—…ç¨‹å®Œç¾çš„ä¼‘æ­¢ç¬¦ï¼Œé©åˆåœ¨æ­¤é‡é¤ä¼‘æ¯ã€‚", query: "æ±æ­¢æ˜Ÿåº§å…¬åœ’" }
        };

        // ==========================================
        // ğŸš€ æ ¸å¿ƒé‚è¼¯
        // ==========================================
        
        // 1. åˆå§‹åŒ–
        window.onload = function() {
            liff.init({ liffId: MY_LIFF_ID }).then(() => {
                if (!liff.isLoggedIn()) {
                    liff.login();
                } else {
                    renderContent();
                    trackAction('view_page'); // è¿½è¹¤é é¢ç€è¦½
                }
            }).catch(err => {
                console.error(err);
                // å³ä½¿ LIFF å¤±æ•—ä¹Ÿå˜—è©¦æ¸²æŸ“ï¼Œæ–¹ä¾¿é›»è…¦æ¸¬è©¦
                renderContent(); 
            });
        };

        // 2. æ¸²æŸ“ç•«é¢
        function renderContent() {
            const urlParams = new URLSearchParams(window.location.search);
            const spotKey = urlParams.get('id') || 'spot1'; // é è¨­é¡¯ç¤ºç¬¬1ç«™
            const data = spotsData[spotKey];

            if (data) {
                // å¡«å…¥æ–‡å­—èˆ‡åœ–ç‰‡
                document.getElementById('spot-index').innerText = data.id;
                document.getElementById('spot-title').innerText = data.title;
                document.getElementById('spot-desc').innerText = data.desc;
                // åœ–ç‰‡è·¯å¾‘è™•ç†ï¼šå¦‚æœæœ¬åœ°æœ‰å°±ç”¨æœ¬åœ°ï¼Œæ²’æœ‰å¯ç”¨ placeholder
                document.getElementById('spot-img').src = data.img; 

                // è¨­å®šåº•éƒ¨å°èˆªæŒ‰éˆ•é€£çµ
                document.getElementById('map-btn').href = `http://googleusercontent.com/maps.google.com/9{encodeURIComponent(data.query)}`;
                document.getElementById('food-btn').href = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(data.query + " ç¾é£Ÿ")}`;

                // åˆå§‹åŒ–é›†ç« ç‹€æ…‹
                initStamps(spotKey);

                // ç§»é™¤è¼‰å…¥å‹•ç•«
                document.getElementById('loading').style.display = 'none';
                document.getElementById('main-content').style.display = 'block';
            }
        }

        // 3. æ‘ºç–Šç°¡ä»‹åŠŸèƒ½
        function toggleDesc() {
            const container = document.getElementById('spot-desc-container');
            const btn = document.getElementById('read-more-btn');
            container.classList.toggle('expanded');
            
            if (container.classList.contains('expanded')) {
                btn.innerText = "â–² æ”¶èµ·ç°¡ä»‹";
                trackAction('expand_desc'); // è¿½è¹¤ï¼šå±•é–‹ç°¡ä»‹
            } else {
                btn.innerText = "â–¼ äº†è§£æ›´å¤šæ•…äº‹";
            }
        }

        // 4. é›†ç« ç³»çµ± (LocalStorage)
        function initStamps(currentSpotKey) {
            // å¾æ‰‹æ©Ÿè¨˜æ†¶é«”è®€å–é€²åº¦
            let collected = JSON.parse(localStorage.getItem('xizhi_stamps')) || [];
            
            const container = document.getElementById('stamp-container');
            container.innerHTML = ''; // æ¸…ç©º
            
            // ç”Ÿæˆ 8 å€‹åœˆåœˆ
            for(let i=1; i<=8; i++) {
                let spotId = 'spot' + i;
                let isCollected = collected.includes(spotId);
                let div = document.createElement('div');
                div.className = isCollected ? 'stamp active' : 'stamp';
                div.innerText = i;
                container.appendChild(div);
            }

            // æ›´æ–°é€²åº¦æ–‡å­—èˆ‡é ‚éƒ¨é€²åº¦æ¢
            document.getElementById('progress-text').innerText = `${collected.length}/8`;
            document.getElementById('progress-bar').style.width = `${(collected.length/8)*100}%`;

            // æª¢æŸ¥ç•¶å‰æ™¯é»æ˜¯å¦å·²æ‰“å¡
            const btn = document.getElementById('checkin-btn');
            if (collected.includes(currentSpotKey)) {
                btn.innerText = "âœ… å·²å®Œæˆæ‰“å¡";
                btn.disabled = true;
                btn.style.background = "#ccc";
            } else {
                btn.innerText = "ğŸ“ æŠµé”æ‰“å¡ (+1)";
                btn.disabled = false;
                btn.style.background = "#27ae60";
            }

            // å¦‚æœé›†æ»¿ 8 å€‹ï¼Œé¡¯ç¤ºå•å·å€å¡Š
            if (collected.length >= 8) {
                document.getElementById('survey-box').style.display = 'block';
            }
        }

        // 5. æ‰“å¡å‹•ä½œ
        function doCheckIn() {
            const urlParams = new URLSearchParams(window.location.search);
            const currentSpotKey = urlParams.get('id') || 'spot1';
            
            let collected = JSON.parse(localStorage.getItem('xizhi_stamps')) || [];
            
            if (!collected.includes(currentSpotKey)) {
                collected.push(currentSpotKey);
                localStorage.setItem('xizhi_stamps', JSON.stringify(collected));
                
                // æˆåŠŸç‰¹æ•ˆèˆ‡æ›´æ–°
                alert("ğŸ‰ æ‰“å¡æˆåŠŸï¼ç²å¾—ç¬¬ " + spotsData[currentSpotKey].id + " æšå°ç« ï¼");
                initStamps(currentSpotKey);
                trackAction('check_in'); // è¿½è¹¤ï¼šæ‰“å¡æˆåŠŸ
            }
        }

        // 6. è¡Œç‚ºè¿½è¹¤ (å‚³é€æ•¸æ“šåˆ° Make)
        function trackAction(actionName) {
            if (!WEBHOOK_URL) return; // å¦‚æœæ²’è¨­å®šç¶²å€å°±ä¸åŸ·è¡Œ

            const urlParams = new URLSearchParams(window.location.search);
            const spotId = urlParams.get('id') || 'spot1';
            
            // å˜—è©¦å–å¾— User ID (éœ€ç™»å…¥)
            let userId = "unknown";
            try { userId = liff.getContext().userId; } catch(e) {}

            // ä½¿ç”¨ fetch å‚³é€ (ä¸ç­‰å¾…å›æ‡‰ï¼Œé¿å…å¡ä½ä»‹é¢)
            fetch(WEBHOOK_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    userId: userId,
                    action: actionName,
                    spot: spotId,
                    timestamp: new Date().toISOString()
                })
            }).catch(console.error);
        }
    </script>
</body>
</html>
